import{c as O,r,j as e,C as se,a as L,b as G,X as J,u as W,R as te,P as re}from"./sidepanel-DBKoi8z6.js";import{P as K}from"./icons-BrWGVAbi.js";import{C as T,a as M}from"./card-dtX_kZak.js";import{L as ne,B as D}from"./button-DwShjOZh.js";import{E as ae}from"./external-link-CrcFS5Hs.js";import{g as le,s as Y,e as $,a as oe,b as ie,c as ce,A as q}from"./alert-D8dZtk6k.js";import{B as P,d as H}from"./badge-CZaMXL-c.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=O("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=O("Globe",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=O("OctagonAlert",[["path",{d:"M12 16h.01",key:"1drbdi"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M15.312 2a2 2 0 0 1 1.414.586l4.688 4.688A2 2 0 0 1 22 8.688v6.624a2 2 0 0 1-.586 1.414l-4.688 4.688a2 2 0 0 1-1.414.586H8.688a2 2 0 0 1-1.414-.586l-4.688-4.688A2 2 0 0 1 2 15.312V8.688a2 2 0 0 1 .586-1.414l4.688-4.688A2 2 0 0 1 8.688 2z",key:"1fd625"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=O("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]),B=r.forwardRef(({className:s,src:t,alt:n,fallback:a,size:l="md",variant:o="circle",status:f,loading:p=!1,error:x=!1,...i},u)=>{const[N,w]=r.useState(!1),c={xs:"w-5 h-5 text-xs",sm:"w-8 h-8 text-xs",md:"w-9 h-9 text-sm",lg:"w-12 h-12 text-base",xl:"w-16 h-16 text-lg"},h={xs:10,sm:12,md:14,lg:16,xl:18}[l],d={online:"hsl(var(--success))",offline:"hsl(var(--muted-foreground))",away:"hsl(var(--warning))",busy:"hsl(var(--destructive))"},C=x||N;return e.jsxs("div",{ref:u,className:L("relative inline-flex flex-shrink-0",c[l],s),...i,children:[e.jsxs("div",{className:L("relative inline-flex items-center justify-center overflow-hidden","bg-card text-card-foreground font-semibold",{"rounded-full":o==="circle","rounded-lg":o==="square"}),children:[p&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-card/50 backdrop-blur-sm",children:e.jsx(ne,{size:h,className:"animate-spin text-muted-foreground"})}),!C&&t?e.jsx("img",{src:t,alt:n||"",className:"w-full h-full object-cover",onError:()=>w(!0)}):C&&!a?e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-destructive/10",children:e.jsx(se,{size:h,className:"text-destructive"})}):e.jsx("span",{"aria-label":n||a||"Avatar",children:a})]}),f&&e.jsx("span",{className:L("absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full ring-2 ring-background","border-2 border-background"),style:{backgroundColor:d[f]},role:"status","aria-label":`Status: ${f}`})]})});B.displayName="Avatar";function xe({data:s}){var n,a;K[s.platform]||K.generic;const t=l=>l||"";return e.jsx(T,{variant:"default",className:"hover:scale-[1.02] hover:border-border/80",children:e.jsxs(M,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[e.jsx(B,{src:s.avatarUrl,fallback:((n=s.name)==null?void 0:n.charAt(0).toUpperCase())||((a=s.ogTitle)==null?void 0:a.charAt(0).toUpperCase())||"?",size:"md",variant:"circle"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h2",{className:"text-base font-semibold text-foreground truncate",children:s.name||s.ogTitle||s.title}),s.headline&&e.jsx("p",{className:"text-sm text-muted-foreground mt-0.5 line-clamp-2",children:s.headline}),(s.location||s.company)&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1 font-mono",children:[s.location,s.company].filter(Boolean).join(" Â· ")}),s.followers&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-0.5 font-numerical",children:[t(s.followers)," followers"]})]})]}),s.bio&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3 mb-3",children:s.bio}),s.about&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3 mb-3",children:s.about}),s.recentPosts&&s.recentPosts.length>0&&e.jsxs("div",{className:"border-t border-border pt-3 mt-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Recent posts"}),e.jsx("div",{className:"space-y-2",children:s.recentPosts.slice(0,3).map((l,o)=>e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2",children:l},o))})]})]})})}const he=r.memo(xe,(s,t)=>s.data.name===t.data.name&&s.data.headline===t.data.headline&&s.data.bio===t.data.bio);function ge({data:s}){return e.jsx(T,{variant:"default",children:e.jsxs(M,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[e.jsx(B,{fallback:e.jsx(ue,{size:20}),size:"md",variant:"circle"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h2",{className:"text-base font-semibold text-foreground truncate",children:s.hostname}),s.ogTitle&&e.jsx("p",{className:"text-sm text-muted-foreground mt-0.5 line-clamp-2",children:s.ogTitle}),!s.ogTitle&&s.h1&&e.jsx("p",{className:"text-sm text-muted-foreground mt-0.5 line-clamp-2",children:s.h1})]})]}),s.ogDescription&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3 mb-3",children:s.ogDescription}),s.socialLinks&&s.socialLinks.length>0&&e.jsxs("div",{className:"border-t border-border pt-3 mt-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Detected social links"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.socialLinks.map((t,n)=>e.jsxs("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-primary hover:underline inline-flex items-center gap-1",children:[new URL(t).hostname,e.jsx(ae,{size:12})]},n))})]}),s.email&&e.jsxs("div",{className:"border-t border-border pt-3 mt-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Contact"}),e.jsx("a",{href:`mailto:${s.email}`,className:"text-sm text-primary hover:underline",children:s.email})]})]})})}const pe=r.memo(ge,(s,t)=>s.data.hostname===t.data.hostname&&s.data.ogTitle===t.data.ogTitle&&s.data.ogDescription===t.data.ogDescription);function be({text:s,onCopy:t}){const[n,a]=r.useState(!1),l=async()=>{try{await navigator.clipboard.writeText(s),a(!0),t&&t(),setTimeout(()=>a(!1),1e3)}catch(o){console.error("Failed to copy:",o)}};return e.jsx(D,{variant:n?"success":"primary",onClick:l,"aria-label":n?"Copied!":"Copy to clipboard",className:"w-full",children:n?e.jsxs(e.Fragment,{children:[e.jsx(G,{size:16}),"Copied"]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{size:16}),"Copy Message"]})})}const je=r.memo(be,(s,t)=>s.text===t.text);function ye({initialMessage:s,onSave:t,onClose:n}){const[a,l]=r.useState(s),o=a.split(/\s+/).filter(Boolean).length,f=!a.trim()||a===s;return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-end justify-center z-50",children:e.jsx(T,{className:"w-full max-w-md rounded-t-lg animate-slide-up",children:e.jsxs(M,{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-base font-semibold",children:"Edit Message"}),e.jsx("button",{onClick:n,className:"text-muted-foreground hover:text-foreground","aria-label":"Close editor",children:e.jsx(J,{size:18})})]}),e.jsx("textarea",{value:a,onChange:p=>l(p.target.value),className:"w-full h-48 px-3 py-2 rounded-lg bg-card border border-border text-sm text-foreground resize-none focus:outline-none focus:ring-2 focus:ring-primary",placeholder:"Edit your message...","aria-label":"Edit message content"}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right font-numerical",children:[o," words"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(D,{onClick:n,variant:"secondary",size:"md",className:"flex-1",children:"Cancel"}),e.jsxs(D,{onClick:()=>t(a),variant:"primary",size:"md",className:"flex-1",disabled:f,children:[e.jsx(G,{size:16,className:"mr-2"}),"Save Changes"]})]})]})})})}function ve(){const[s,t]=r.useState({}),[n,a]=r.useState({}),[l,o]=r.useState("service"),[f,p]=r.useState(null),[x,i]=r.useState(0),u=W(m=>m.apiKey),N=r.useRef(null),w=r.useRef(null),c=r.useRef(null),h=r.useRef(null),d=3;r.useEffect(()=>{const m=()=>{chrome.storage.local.get("voiceProfile",g=>{g.voiceProfile&&p(g.voiceProfile)})};m();const k=()=>m();return chrome.storage.onChanged.addListener(k),()=>chrome.storage.onChanged.removeListener(k)},[]);const C=r.useCallback(()=>{h.current&&(h.current.abort(),h.current=null)},[]),v=r.useCallback(async(m,k,g)=>{if(!u)return;N.current=m,w.current=k,c.current=g,C();const E=new AbortController;h.current=E,a(S=>({...S,[g]:!0}));try{const S=le(m,k,g,f||void 0);let R="";await Y([{role:"system",content:"You are a helpful assistant that generates personalized outreach messages."},{role:"user",content:S}],u,{signal:E.signal,onChunk:z=>{R+=z;try{const b=$(R),j=JSON.parse(b);j.message&&t(y=>({...y,[g]:j}))}catch{}},onComplete:z=>{try{const b=$(z),j=JSON.parse(b);t(y=>({...y,[g]:j})),a(y=>({...y,[g]:!1})),i(0)}catch{a(b=>({...b,[g]:!1}))}h.current=null},onError:z=>{if(z instanceof DOMException&&z.name==="AbortError"){a(y=>({...y,[g]:!1}));return}const b=z instanceof Error?z.message:"Generation failed";if((b.includes("network")||b.includes("timeout")||b.includes("503")||b.includes("502"))&&x<d){i(I=>I+1);const y=Math.pow(2,x)*1e3;setTimeout(()=>{N.current&&w.current&&c.current&&v(N.current,w.current,c.current)},y)}else a(y=>({...y,[g]:!1})),i(0);h.current=null}})}catch(S){if(S instanceof DOMException&&S.name==="AbortError"){a(R=>({...R,[g]:!1}));return}a(R=>({...R,[g]:!1})),h.current=null}},[u,f,x,C]),A=r.useCallback(async(m,k,g)=>{t(E=>({...E,[g]:null})),await v(m,k,g)},[v]);return{messages:s,isGenerating:n,selectedAngle:l,setSelectedAngle:o,generateMessage:v,regenerateMessage:A,cancelGeneration:C,setMessages:t}}const U=r.createContext(void 0),F=r.forwardRef(({defaultValue:s,value:t,onValueChange:n,children:a,className:l},o)=>{const[f,p]=r.useState(s),x=t??f,i=u=>{t===void 0&&p(u),n==null||n(u)};return e.jsx(U.Provider,{value:{value:x,onValueChange:i},children:e.jsx("div",{ref:o,className:l,children:a})})});F.displayName="TabsRoot";const _=r.forwardRef(({children:s,className:t},n)=>e.jsx("div",{ref:n,role:"tablist","aria-orientation":"horizontal",className:L("relative inline-flex items-center gap-1 rounded-lg bg-muted/50 border border-border/50 p-1",t),children:s}));_.displayName="TabsList";const X=r.forwardRef(({value:s,children:t,disabled:n=!1,className:a},l)=>{const o=r.useContext(U);if(!o)throw new Error("TabsTrigger must be used within TabsRoot");const{value:f,onValueChange:p}=o,x=f===s;return e.jsx("button",{ref:l,type:"button",disabled:n,role:"tab","aria-selected":x,"aria-controls":`panel-${s}`,id:`tab-${s}`,tabIndex:x?0:-1,onClick:()=>!n&&p(s),onKeyDown:i=>{var w,c,h,d,C,v,A;const u=Array.from(((w=i.currentTarget.parentElement)==null?void 0:w.querySelectorAll('[role="tab"]'))||[]),N=u.indexOf(i.currentTarget);switch(i.key){case"ArrowLeft":case"ArrowRight":i.preventDefault();const m=i.key==="ArrowLeft"?-1:1,k=(N+m+u.length)%u.length;(c=u[k])==null||c.focus(),(h=u[k])==null||h.click();break;case"Home":i.preventDefault(),(d=u[0])==null||d.focus(),(C=u[0])==null||C.click();break;case"End":i.preventDefault(),(v=u[u.length-1])==null||v.focus(),(A=u[u.length-1])==null||A.click();break;case"Enter":case" ":i.preventDefault(),i.currentTarget.click();break}},className:L("relative px-4 py-2 rounded-md font-medium text-sm transition-all duration-150 ease-in-out","focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background","disabled:opacity-50 disabled:cursor-not-allowed",{"bg-primary text-primary-foreground":x,"text-muted-foreground hover:text-foreground hover:bg-card/50":!x},a),children:t})});X.displayName="TabsTrigger";const Q=r.forwardRef(({value:s,children:t,className:n},a)=>{const l=r.useContext(U);if(!l)throw new Error("TabsContent must be used within TabsRoot");const{value:o}=l;return o===s?e.jsx("div",{ref:a,role:"tabpanel",id:`panel-${s}`,"aria-labelledby":`tab-${s}`,tabIndex:0,className:n,children:t}):null});Q.displayName="TabsContent";const V=Object.assign(F,{Root:F,List:_,Trigger:X,Content:Q});function Ne(s){return s>=80?{label:"Sounds like you",variant:"success"}:s>=60?{label:"Close match",variant:"info"}:s>=40?{label:"Moderate match",variant:"warning"}:{label:"Generic tone",variant:"error"}}function Ce({pageData:s,analysis:t,selectedAngle:n,onSelectAngle:a,onCopy:l,onRegenerate:o}){const{messages:f,isGenerating:p,generateMessage:x,regenerateMessage:i,setMessages:u}=ve(),[N,w]=r.useState(!1),c=f[n],h=p[n],d=m=>{a(m),!f[m]&&!p[m]&&x(s,t,m)},C=()=>{i(s,t,n),o&&o()},v=()=>{l&&c&&l(c.message)};!c&&!h&&t&&x(s,t,n);const A=c?Ne(c.voiceScore):null;return e.jsxs(T,{variant:"default",className:"space-y-4",children:[e.jsxs(M,{className:"space-y-4",children:[(t==null?void 0:t.outreachAngles)&&e.jsx(V.Root,{defaultValue:n,value:n,onValueChange:d,children:e.jsx(V.List,{children:t.outreachAngles.map(m=>e.jsx(V.Trigger,{value:m.angle,children:m.angle.charAt(0).toUpperCase()+m.angle.slice(1)},m.angle))})}),h&&!c&&e.jsxs("div",{role:"status","aria-live":"polite","aria-label":"Generating message",className:"space-y-3 py-4",children:[e.jsx("div",{className:"h-3 bg-muted rounded w-full animate-pulse"}),e.jsx("div",{className:"h-3 bg-muted rounded w-5/6 animate-pulse"}),e.jsx("div",{className:"h-3 bg-muted rounded w-4/6 animate-pulse"})]}),c&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm text-foreground whitespace-pre-wrap leading-relaxed",children:c.message}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground pt-3 border-t border-border",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[A&&e.jsx(P,{variant:A.variant,size:"sm",children:A.label}),e.jsxs("span",{className:"font-numerical",children:[c.voiceScore,"%"]})]}),e.jsxs("span",{className:"font-numerical",children:[c.wordCount,"w"]})]}),c.hook&&e.jsxs("p",{className:"text-xs text-muted-foreground italic",children:["Hook: ",c.hook]}),e.jsx(je,{text:c.message,onCopy:v})]}),c&&e.jsxs("div",{className:"flex gap-2 pt-3 border-t border-border",children:[e.jsxs(D,{variant:"secondary",size:"sm",onClick:C,disabled:h,className:"flex-1",children:[e.jsx(te,{size:14,className:h?"animate-spin":""}),"Regenerate"]}),e.jsxs(D,{variant:"ghost",size:"sm",onClick:()=>w(!0),className:"flex-1","aria-label":"Edit this message",children:[e.jsx(fe,{size:14}),"Edit"]})]})]}),N&&c&&e.jsx(ye,{initialMessage:c.message,onSave:m=>{u(k=>({...k,[n]:{...c,message:m,wordCount:m.split(/\s+/).filter(Boolean).length}})),w(!1)},onClose:()=>w(!1)})]})}const we=r.memo(Ce,(s,t)=>{var n,a,l,o,f,p,x,i;return s.pageData.url===t.pageData.url&&s.selectedAngle===t.selectedAngle&&((n=s.analysis)==null?void 0:n.personName)===((a=t.analysis)==null?void 0:a.personName)&&((l=s.analysis)==null?void 0:l.confidence)===((o=t.analysis)==null?void 0:o.confidence)&&((p=(f=s.analysis)==null?void 0:f.outreachAngles)==null?void 0:p.length)===((i=(x=t.analysis)==null?void 0:x.outreachAngles)==null?void 0:i.length)});function ke({isOpen:s,onClose:t,onLogged:n}){const[a,l]=r.useState(!1);r.useEffect(()=>{s&&l(!0)},[s]);const o=r.useCallback(x=>{s&&(x.key==="Escape"?p():x.key==="Enter"&&f())},[s]);if(r.useEffect(()=>(document.addEventListener("keydown",o),()=>document.removeEventListener("keydown",o)),[o]),!s)return null;const f=()=>{n(),l(!1),setTimeout(()=>t(),300)},p=()=>{l(!1),setTimeout(()=>t(),300)};return e.jsx("div",{className:`
        fixed inset-0 bg-black/50 backdrop-blur-[1px] flex items-end justify-center z-50
        transition-opacity duration-300
        ${a?"opacity-100":"opacity-0"}
      `,onClick:p,role:"dialog","aria-modal":"true","aria-label":"Log conversation",children:e.jsxs("div",{className:`
          w-full max-w-md bg-card border-t border-border rounded-t-xl p-6
          transition-transform duration-300
          ${a?"translate-y-0":"translate-y-full"}
        `,onClick:x=>x.stopPropagation(),children:[e.jsx("div",{className:"w-10 h-1 bg-muted rounded-full mx-auto mb-4"}),e.jsx("p",{className:"text-sm font-medium text-foreground text-center mb-2",children:"Message copied!"}),e.jsx("p",{className:"text-xs text-muted-foreground text-center mb-6",children:"Did you send it? We'll track it in your history."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(D,{onClick:f,variant:"primary",size:"md",className:"flex-1",children:[e.jsx(G,{size:16,className:"mr-2"}),"Yes, sent it"]}),e.jsxs(D,{onClick:p,variant:"secondary",size:"md",className:"flex-1",children:[e.jsx(J,{size:16,className:"mr-2"}),"Not yet"]})]}),e.jsxs("p",{className:"text-[10px] text-muted-foreground text-center mt-3",children:["Press ",e.jsx("kbd",{className:"px-1 py-0.5 rounded bg-muted border border-border font-mono",children:"Enter"})," to confirm or ",e.jsx("kbd",{className:"px-1 py-0.5 rounded bg-muted border border-border font-mono",children:"Esc"})," to dismiss"]})]})})}function Se({value:s,max:t=100,size:n="md",variant:a,showValue:l=!1,label:o,color:f,className:p,...x}){const i=Math.min(Math.max(s/t*100,0),100),u=a||(i>=60?"success":i>=30?"warning":"error"),N={default:"bg-muted-foreground",success:"bg-success",warning:"bg-warning",error:"bg-destructive"};return e.jsxs("div",{className:L("space-y-2",p),...x,children:[(o||l)&&e.jsxs("div",{className:"flex items-center justify-between",children:[o&&e.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:o}),l&&e.jsxs("span",{className:L("text-sm font-semibold font-numerical",N[u]),children:[Math.round(i),"%"]})]}),e.jsx("div",{role:"progressbar","aria-valuenow":Math.round(i),"aria-valuemin":0,"aria-valuemax":100,className:L("w-full bg-muted rounded-full overflow-hidden",{"h-1":n==="sm","h-2":n==="md","h-3":n==="lg"}),children:e.jsx("div",{className:L("h-full rounded-full transition-all duration-300",f?"":N[u]),style:{width:`${i}%`,transitionTimingFunction:"cubic-bezier(0.4, 0.0, 0.2, 1)",...f&&{backgroundColor:f}}})})]})}function Ae(){const[s,t]=r.useState(null),[n,a]=r.useState(!1),[l,o]=r.useState(!1),[f,p]=r.useState(0),[x,i]=r.useState(null),[u,N]=r.useState(0),w=W(g=>g.apiKey),c=r.useRef(null),h=r.useRef(null),d=r.useRef(null),C=r.useRef(null),v=r.useRef(null),A=3,m=r.useCallback(()=>{v.current&&(v.current.abort(),v.current=null),c.current&&(clearTimeout(c.current),c.current=null),h.current&&(clearInterval(h.current),h.current=null),o(!1),p(0),a(!1),d.current=null},[]),k=r.useCallback(async g=>{if(!w){i("No API key configured");return}if(d.current===g.url&&(n||l))return;m(),d.current=g.url,C.current=g,o(!0),p(1),i(null);let E=1;h.current=setInterval(()=>{E--,p(E),E<=0&&h.current&&(clearInterval(h.current),h.current=null)},1e3),c.current=setTimeout(async()=>{o(!1),a(!0),t(null);try{const S=await oe(g.url);if(S){t(S),a(!1),d.current=null;return}const R=new AbortController;v.current=R;const z=ie(g);let b="";await Y([{role:"system",content:"You are a helpful assistant that analyzes webpages for outreach purposes."},{role:"user",content:z}],w,{signal:R.signal,onChunk:j=>{b+=j;try{const y=$(b),I=JSON.parse(y);I.confidence&&t(I)}catch{}},onComplete:async j=>{try{const y=$(j),I=JSON.parse(y);t(I),await ce(g.url,I),N(0)}catch{i("Failed to parse analysis response")}a(!1),d.current=null,v.current=null},onError:j=>{if(j instanceof DOMException&&j.name==="AbortError")return;const y=j instanceof Error?j.message:"Analysis failed";if((y.includes("network")||y.includes("timeout")||y.includes("503")||y.includes("502"))&&u<A){N(ee=>ee+1);const Z=Math.pow(2,u)*1e3;setTimeout(()=>{C.current&&k(C.current)},Z)}else i(y),a(!1),d.current=null,v.current=null,N(0)}})}catch(S){if(S instanceof DOMException&&S.name==="AbortError")return;i(S instanceof Error?S.message:"Analysis failed"),a(!1),d.current=null,v.current=null}},1e3)},[w,n,l,m,u]);return{analysis:s,isAnalyzing:n,isDebouncing:l,debounceCountdown:f,error:x,analyzePage:k,cancelAnalysis:m}}function Ie({initialData:s}){const[t,n]=r.useState(s),[a,l]=r.useState(!s),[o,f]=r.useState("service"),[p,x]=r.useState(!1),[i,u]=r.useState(!1),[N,w]=r.useState(""),[c,h]=r.useState(null),{analysis:d,isAnalyzing:C,isDebouncing:v,debounceCountdown:A,error:m,analyzePage:k,cancelAnalysis:g}=Ae();r.useEffect(()=>{const b=j=>{if(j.currentPageData){const y=j.currentPageData.newValue;n(y),l(!1),u(!1),h(null)}};return chrome.storage.session.onChanged.addListener(b),()=>chrome.storage.session.onChanged.removeListener(b)},[]),r.useEffect(()=>{(async()=>{if(t!=null&&t.url)try{const j=await H.conversations.where("pageUrl").equals(t.url).count();j>0?h(`You've already sent ${j} message${j>1?"s":""} to this page.`):h(null)}catch{}})()},[t==null?void 0:t.url]);const E=()=>{t&&!d&&!C&&!i&&(u(!0),k(t))},S=b=>{b&&w(b),setTimeout(()=>x(!0),100)},R=async()=>{if(!(!t||!N))try{await H.conversations.add({id:`${Date.now()}-${Math.random().toString(36).slice(2,9)}`,platform:t.platform,pageUrl:t.url,pageName:(d==null?void 0:d.personName)||t.name||t.ogTitle||t.hostname,sentMessage:N,angle:o,sentAt:Date.now(),status:"sent"})}catch(b){console.error("[OutreachScreen] Failed to log conversation:",b)}};if(a)return e.jsxs("div",{className:"space-y-4",children:[e.jsx(re,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-3 bg-muted rounded w-1/4"}),e.jsx("div",{className:"h-3 bg-muted rounded w-full"}),e.jsx("div",{className:"h-3 bg-muted rounded w-5/6"})]})]});if(!t)return e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-[13px] leading-relaxed text-muted-foreground",children:"Waiting for page data..."})});const z=t.isProfile||t.name;return e.jsxs("div",{className:"space-y-4",children:[z?e.jsx(he,{data:t}):e.jsx(pe,{data:t}),c&&e.jsx(q,{variant:"warning",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{size:14,className:"shrink-0"}),e.jsx("span",{children:c})]})}),m&&e.jsx(q,{variant:"error",children:m}),t&&!d&&!C&&!v&&!i&&e.jsx(T,{variant:"default",children:e.jsxs(M,{className:"p-4 text-center",children:[e.jsx("div",{className:"mb-4 flex justify-center",children:e.jsx(P,{variant:"info",size:"md",children:"Ready to analyze"})}),e.jsx("h3",{className:"text-sm font-semibold leading-tight text-foreground mb-2",children:t.name||t.ogTitle||t.hostname}),e.jsxs("p",{className:"text-[13px] leading-relaxed text-muted-foreground mb-6",children:["We'll analyze this ",t.isProfile?"profile":"page"," and generate personalized outreach messages."]}),e.jsx(D,{onClick:E,variant:"primary",size:"md",className:"w-full",children:"Analyze This Page"})]})}),v&&e.jsx(T,{variant:"default",children:e.jsxs(M,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center gap-2 mb-2",children:e.jsx(P,{variant:"info",size:"sm",children:"Starting analysis..."})}),e.jsxs("p",{className:"text-xs leading-normal text-muted-foreground",children:["Analyzing in ",A," second",A!==1?"s":""]}),e.jsx(D,{onClick:g,variant:"ghost",size:"xs",className:"mt-3",children:"Cancel"})]})}),C&&!d&&e.jsx(T,{variant:"default",children:e.jsx(M,{className:"p-4 text-center",children:e.jsx(P,{variant:"info",size:"sm",children:"Analyzing page..."})})}),d&&e.jsxs(e.Fragment,{children:[e.jsx(T,{variant:"default",children:e.jsxs(M,{className:"p-4",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsx("span",{className:"text-xs leading-normal text-muted-foreground",children:"Confidence"})}),e.jsx(Se,{value:d.confidence,showValue:!0,size:"md"})]}),d.confidenceReason&&e.jsx("p",{className:"text-xs leading-normal text-muted-foreground mt-2",children:d.confidenceReason})]})}),d.summary&&e.jsx(T,{variant:"default",children:e.jsxs(M,{className:"p-4",children:[e.jsx("h3",{className:"text-sm font-semibold leading-tight text-muted-foreground mb-2",children:"Summary"}),e.jsx("p",{className:"text-[13px] leading-relaxed text-muted-foreground",children:d.summary})]})}),d.interests&&d.interests.length>0&&e.jsx(T,{variant:"default",children:e.jsxs(M,{className:"p-4",children:[e.jsx("h3",{className:"text-sm font-semibold leading-tight text-muted-foreground mb-2",children:"Interests"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:d.interests.map((b,j)=>e.jsx(P,{variant:"default",size:"sm",children:b},j))})]})})]}),d&&t&&e.jsx(we,{pageData:t,analysis:d,selectedAngle:o,onSelectAngle:f,onCopy:S}),e.jsx(ke,{isOpen:p,onClose:()=>x(!1),onLogged:R})]})}export{Ie as default};
