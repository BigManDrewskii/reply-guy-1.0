import{c as K,r as l,j as e,C as xe,a as H,b as Q,u as W,Z as ce,R as ae,d as pe,P as be}from"./sidepanel-90hatnpU.js";import{P as oe}from"./icons-DH_oACYJ.js";import{C as B,a as U,b as _,c as Y,B as de,d as Z}from"./badge-xtkdSOar.js";import{L as ye,B as G}from"./button-D54yiX8W.js";import{E as ue}from"./external-link-BdOoLGVK.js";import{f as we,c as ve,C as je,A as ie}from"./alert-DMOXoPDv.js";import{s as te,e as J,g as Ne,a as ke}from"./openrouter-Bhx_IZfW.js";import{f as le,c as Ce,a as Se}from"./crm-Dbu9Or-j.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=K("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ae=K("Globe",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=K("MessageCircle",[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=K("OctagonAlert",[["path",{d:"M12 16h.01",key:"1drbdi"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M15.312 2a2 2 0 0 1 1.414.586l4.688 4.688A2 2 0 0 1 22 8.688v6.624a2 2 0 0 1-.586 1.414l-4.688 4.688a2 2 0 0 1-1.414.586H8.688a2 2 0 0 1-1.414-.586l-4.688-4.688A2 2 0 0 1 2 15.312V8.688a2 2 0 0 1 .586-1.414l4.688-4.688A2 2 0 0 1 8.688 2z",key:"1fd625"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=K("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]);function Me(t){let s=0;for(let i=0;i<t.length;i++)s=t.charCodeAt(i)+((s<<5)-s);const n=Math.abs(s%360),r=(n+40)%360;return`linear-gradient(135deg, oklch(0.55 0.15 ${n}), oklch(0.45 0.18 ${r}))`}const ne=l.forwardRef(({className:t,src:s,alt:n,fallback:r,size:i="md",variant:o="circle",status:d,loading:c=!1,error:h=!1,...f},y)=>{const[C,w]=l.useState(!1),D={xs:"w-5 h-5 text-[9px]",sm:"w-8 h-8 text-xs",md:"w-10 h-10 text-sm",lg:"w-12 h-12 text-base",xl:"w-16 h-16 text-lg"},S={xs:10,sm:12,md:14,lg:16,xl:18}[i],x={online:"var(--color-success)",offline:"var(--color-muted-foreground)",away:"var(--color-warning)",busy:"var(--color-destructive)"},j=h||C,R=j||!s,A=l.useMemo(()=>Me(r||n||"?"),[r,n]);return e.jsxs("div",{ref:y,className:H("relative inline-flex flex-shrink-0",D[i],t),...f,children:[e.jsxs("div",{className:H("relative w-full h-full inline-flex items-center justify-center overflow-hidden","font-semibold text-white",{"rounded-full":o==="circle","rounded-lg":o==="square"}),style:R?{background:A}:void 0,children:[c&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-card/50 backdrop-blur-sm z-10",children:e.jsx(ye,{size:S,className:"animate-spin text-muted-foreground"})}),R?j&&!r?e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-destructive/10",children:e.jsx(xe,{size:S,className:"text-destructive"})}):e.jsx("span",{className:"select-none","aria-label":n||r||"Avatar",children:r}):e.jsx("img",{src:s,alt:n||"",className:"w-full h-full object-cover",onError:()=>w(!0)})]}),d&&e.jsx("span",{className:H("absolute bottom-0 right-0 block rounded-full ring-2 ring-background",{"h-1.5 w-1.5":i==="xs"||i==="sm","h-2.5 w-2.5":i==="md"||i==="lg","h-3 w-3":i==="xl"}),style:{backgroundColor:x[d]},role:"status","aria-label":`Status: ${d}`})]})});ne.displayName="Avatar";function $e({data:t}){var n,r;const s=oe[t.platform]||oe.generic;return e.jsx(B,{variant:"default",children:e.jsxs(U,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx(ne,{src:t.avatarUrl,fallback:((n=t.name)==null?void 0:n.charAt(0).toUpperCase())||((r=t.ogTitle)==null?void 0:r.charAt(0).toUpperCase())||"?",size:"lg",variant:"circle"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("h2",{className:"text-[15px] font-semibold text-foreground truncate",children:t.name||t.ogTitle||t.title}),e.jsx(s,{size:14,className:"text-muted-foreground shrink-0"})]}),(t.location||t.company)&&e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 truncate",children:[t.location,t.company].filter(Boolean).join(" · ")}),t.headline&&e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 line-clamp-1",children:t.headline})]})]}),t.bio&&e.jsx("p",{className:"text-[13px] leading-relaxed text-muted-foreground line-clamp-3 mb-3",children:t.bio}),t.about&&!t.bio&&e.jsx("p",{className:"text-[13px] leading-relaxed text-muted-foreground line-clamp-3 mb-3",children:t.about}),t.followers&&e.jsx("div",{className:"flex items-center gap-3 text-xs text-muted-foreground pb-3 mb-3 border-b border-border/60",children:e.jsxs("span",{children:[e.jsx("span",{className:"text-foreground font-medium",children:t.followers})," followers"]})}),t.recentPosts&&t.recentPosts.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] font-medium text-muted-foreground uppercase tracking-wide mb-2",children:"Recent posts"}),e.jsx("div",{className:"space-y-1.5",children:t.recentPosts.slice(0,3).map((i,o)=>e.jsx("p",{className:"text-xs text-muted-foreground/80 line-clamp-2 leading-relaxed",children:i},o))})]})]})})}const Ie=l.memo($e,(t,s)=>t.data.name===s.data.name&&t.data.headline===s.data.headline&&t.data.bio===s.data.bio);function Le({data:t}){return e.jsx(B,{variant:"default",children:e.jsxs(U,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[e.jsx(ne,{fallback:e.jsx(Ae,{size:20}),size:"md",variant:"circle"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h2",{className:"text-base font-semibold text-foreground truncate",children:t.hostname}),t.ogTitle&&e.jsx("p",{className:"text-sm text-muted-foreground mt-0.5 line-clamp-2",children:t.ogTitle}),!t.ogTitle&&t.h1&&e.jsx("p",{className:"text-sm text-muted-foreground mt-0.5 line-clamp-2",children:t.h1})]})]}),t.ogDescription&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3 mb-3",children:t.ogDescription}),t.socialLinks&&t.socialLinks.length>0&&e.jsxs("div",{className:"border-t border-border pt-3 mt-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Detected social links"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:t.socialLinks.map((s,n)=>e.jsxs("a",{href:s,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-primary hover:underline inline-flex items-center gap-1",children:[new URL(s).hostname,e.jsx(ue,{size:12})]},n))})]}),t.email&&e.jsxs("div",{className:"border-t border-border pt-3 mt-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Contact"}),e.jsx("a",{href:`mailto:${t.email}`,className:"text-sm text-primary hover:underline",children:t.email})]})]})})}const Oe=l.memo(Le,(t,s)=>t.data.hostname===s.data.hostname&&t.data.ogTitle===s.data.ogTitle&&t.data.ogDescription===s.data.ogDescription);function ze({text:t,onCopy:s}){const[n,r]=l.useState(!1),i=async()=>{try{await navigator.clipboard.writeText(t),r(!0),s&&s(),setTimeout(()=>r(!1),1500)}catch(o){console.error("Failed to copy:",o)}};return e.jsx(G,{variant:n?"success":"primary",onClick:i,"aria-label":n?"Copied!":"Copy to clipboard",size:"md",className:"w-full",children:n?e.jsxs(e.Fragment,{children:[e.jsx(Q,{size:15}),"Copied!"]}):e.jsxs(e.Fragment,{children:[e.jsx(Re,{size:15}),"Copy Message"]})})}const Ve=l.memo(ze,(t,s)=>t.text===s.text);function De({initialMessage:t,onSave:s,onClose:n}){const[r,i]=l.useState(t),o=l.useRef(null),d=r.split(/\s+/).filter(Boolean).length,c=!r.trim()||r===t;return l.useEffect(()=>{o.current&&(o.current.focus(),o.current.setSelectionRange(r.length,r.length));const h=f=>{f.key==="Escape"&&n()};return document.addEventListener("keydown",h),()=>document.removeEventListener("keydown",h)},[]),e.jsx("div",{className:"fixed inset-0 bg-background/80 backdrop-blur-sm flex items-end justify-center z-50 animate-fade-in",onClick:n,role:"dialog","aria-modal":"true","aria-label":"Edit message",children:e.jsxs("div",{className:"w-full bg-card border-t border-border/60 rounded-t-2xl animate-slide-up",onClick:h=>h.stopPropagation(),children:[e.jsx("div",{className:"w-8 h-1 bg-muted-foreground/20 rounded-full mx-auto mt-3 mb-2"}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold text-foreground",children:"Edit Message"}),e.jsxs("span",{className:"text-[10px] text-muted-foreground tabular-nums",children:[d,"w"]})]}),e.jsx("textarea",{ref:o,value:r,onChange:h=>i(h.target.value),className:"w-full h-40 px-3 py-2.5 rounded-lg bg-background border border-border/60 text-[13px] text-foreground leading-relaxed resize-none focus:outline-none focus:ring-2 focus:ring-ring/40 focus:border-ring transition-colors",placeholder:"Edit your message...","aria-label":"Edit message content"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(G,{onClick:n,variant:"ghost",size:"sm",className:"flex-1",children:"Cancel"}),e.jsxs(G,{onClick:()=>s(r),variant:"primary",size:"sm",className:"flex-1",disabled:c,children:[e.jsx(Q,{size:13}),"Save"]})]})]})]})})}const Pe={short:"Message must be 40-80 words. Be punchy and direct — 2-3 sentences max. Get to the point fast.",medium:"Message must be 100-150 words. Balance detail with brevity — 3-4 paragraphs.",long:"Message must be 180-250 words. Be thorough — include context, specific references, and a detailed value proposition."},Fe=`MESSAGE STRUCTURE (follow this framework):
1. HOOK (1-2 sentences): Open with something specific about THEM — a recent post, project, or achievement. Make it clear you've done your homework. Never start with "I" or "My".
2. BRIDGE (1-2 sentences): Connect their world to yours. Show you understand their challenges or goals.
3. VALUE (1-2 sentences): What specific value can you offer? Be concrete — not "let's collaborate" but what exactly.
4. CTA (1 sentence): Clear, low-commitment ask. A question works best. Make it easy to say yes.`;function Ge(t){return t.platform==="linkedin"?`You analyze LinkedIn profiles to help craft personalized outreach messages.

PAGE DATA:
${JSON.stringify(t,null,2)}

Return JSON in this exact format (no markdown, no code blocks, just raw JSON):
{
  "personName": "full name from profile",
  "summary": "2-3 sentences about their role, company, and professional focus",
  "interests": ["3-5 professional interests based on headline, about, experience, and skills"],
  "outreachAngles": [
    { "angle": "service", "hook": "specific service you could offer based on their role/company", "relevance": "why it's relevant to their current position" },
    { "angle": "partner", "hook": "partnership opportunity based on complementary skills/industries", "relevance": "mutual benefit explanation" },
    { "angle": "community", "hook": "shared industry/interest connection point", "relevance": "why connecting makes sense" },
    { "angle": "value", "hook": "specific value you could provide (insight, intro, resource)", "relevance": "why they'd care" }
  ],
  "confidence": 0-100,
  "confidenceReason": "based on profile completeness and data quality"
}

LinkedIn-specific rules:
- Use their headline and experience to understand their professional focus
- Reference specific companies, roles, or skills from their profile
- If they have an "About" section, use it to understand their priorities
- Connection degree matters: 1st = warm, 2nd = mutual connections, 3rd = cold
- If experience data is available, reference career trajectory
- Skills endorsements indicate areas of expertise
- interests must be specific professional topics, not generic phrases`:`You analyze webpages to help craft personalized outreach messages.

PAGE DATA:
${JSON.stringify(t,null,2)}

Return JSON in this exact format (no markdown, no code blocks, just raw JSON):
{
  "personName": "best guess — person name or page/company name",
  "summary": "2-3 sentences about who this is and what they do",
  "interests": ["3-5 topics based on available evidence"],
  "outreachAngles": [
    { "angle": "service", "hook": "specific reason", "relevance": "why now" },
    { "angle": "partner", "hook": "...", "relevance": "..." },
    { "angle": "community", "hook": "...", "relevance": "..." },
    { "angle": "value", "hook": "...", "relevance": "..." }
  ],
  "confidence": 0-100,
  "confidenceReason": "based on data quality"
}

Rules:
- If data is sparse, confidence should be lower but ALWAYS provide angles
- Work with whatever context you have. Never refuse.
- For generic sites, focus on what IS visible (title, meta, content)
- interests must be specific topics, not generic phrases
- Each angle must have a unique hook based on actual page content
- confidenceReason should explain the rating`}function Be(t,s,n,r,i="medium"){let o=`Generate a personalized outreach message based on:

PAGE DATA:
${JSON.stringify(t,null,2)}

ANALYSIS:
${JSON.stringify(s,null,2)}

SELECTED ANGLE: ${n}

`;return t.threadContext&&t.threadContext.length>0&&(o+=`THREAD CONTEXT (this person is replying in a conversation):
${t.threadContext.map((d,c)=>`[${c+1}] ${d}`).join(`
`)}

Use the thread context to make the message more relevant and timely.

`),r&&r.register?o+=Ue(r):r&&(o+=qe(r)),o+=`${Fe}

`,o+=He(t),o+=`Return JSON in this exact format (no markdown, no code blocks, just raw JSON):
{
  "message": "personalized message following the Hook→Bridge→Value→CTA structure",
  "wordCount": number,
  "hook": "1-sentence explanation of why this approach works for this specific person",
  "voiceScore": 0-100
}

Rules:
- ${Pe[i]}
- Follow the Hook→Bridge→Value→CTA structure
- Reference specific details from the page/analysis — names, projects, posts, roles
- voiceScore: Rate honestly how well the message matches the voice profile (if provided)
- The message must sound like a REAL PERSON wrote it, not an AI
- Never use clichés like "I hope this finds you well", "I came across your profile", "I'd love to pick your brain"
- Never start with "I" — start with something about THEM`,o}function Ue(t){let s=`═══ VOICE PROFILE (CRITICAL — match this voice precisely) ═══

`;if(s+=`REGISTER DIMENSIONS (Biber's 6-factor model, 1-10 scale):
- Involved↔Informational: ${t.register.involvedVsInformational}/10 (${t.register.involvedVsInformational<=4?"personal/emotional":t.register.involvedVsInformational>=7?"detached/factual":"balanced"})
- Narrative↔Non-narrative: ${t.register.narrativeVsNonNarrative}/10 (${t.register.narrativeVsNonNarrative<=4?"story-like":t.register.narrativeVsNonNarrative>=7?"expository":"mixed"})
- Situation-dependent↔Explicit: ${t.register.situationDependentVsExplicit}/10
- Non-persuasive↔Persuasive: ${t.register.nonPersuasiveVsPersuasive}/10
- Concrete↔Abstract: ${t.register.concreteVsAbstract}/10
- Casual↔Formal: ${t.register.casualVsFormalElaboration}/10

`,s+=`TONE: ${t.tone.primary} (primary), ${t.tone.secondary} (secondary)
- Humor: ${t.tone.humor}
- Confidence: ${t.tone.confidence}
- Style descriptors: ${t.descriptors.join(", ")}

`,t.rules.length>0&&(s+=`VOICE RULES (you MUST follow these):
${t.rules.map((n,r)=>`${r+1}. ${n}`).join(`
`)}

`),t.antiPatterns.length>0&&(s+=`ANTI-PATTERNS (NEVER do these):
${t.antiPatterns.map(n=>`✗ ${n}`).join(`
`)}

`),t.signatures){const n=t.signatures;n.openingPatterns.length>0&&(s+=`OPENING PATTERNS: ${n.openingPatterns.join(" | ")}
`),n.transitionWords.length>0&&(s+=`TRANSITION WORDS: ${n.transitionWords.join(", ")}
`),n.closingPatterns.length>0&&(s+=`CLOSING PATTERNS: ${n.closingPatterns.join(" | ")}
`),n.catchphrases.length>0&&(s+=`CATCHPHRASES: ${n.catchphrases.join(" | ")}
`),s+=`
`}return t.metrics&&(s+=`QUANTITATIVE ANCHORS (match these numbers):
${we(t.metrics)}

`),t.exemplars&&t.exemplars.length>0&&(s+=`═══ WRITING EXEMPLARS (study these carefully — replicate this EXACT style) ═══
${t.exemplars.slice(0,3).map((n,r)=>`--- Exemplar ${r+1} (${n.wordCount} words, ${n.context}) ---
${n.text}`).join(`

`)}

CRITICAL: The message you generate must read as if the SAME PERSON who wrote the exemplars above wrote it. Match their sentence rhythm, word choices, punctuation habits, and energy level.

`),s}function qe(t){var n,r,i;let s=`VOICE PROFILE (match this tone and style):
`;return t.tone!==void 0&&(s+=`- Tone: ${t.tone}/10
`),(n=t.openingPatterns)!=null&&n.length&&(s+=`- Opening patterns: ${t.openingPatterns.join(", ")}
`),(r=t.personalityMarkers)!=null&&r.length&&(s+=`- Personality markers: ${t.personalityMarkers.join(", ")}
`),(i=t.avoidPhrases)!=null&&i.length&&(s+=`- Avoid: ${t.avoidPhrases.join(", ")}
`),t.avgSentenceLength&&(s+=`- Average sentence length: ${t.avgSentenceLength} words
`),t.formalityScore!==void 0&&(s+=`- Formality: ${t.formalityScore}/100
`),s+=`
`,s}function He(t){return t.platform==="linkedin"?`PLATFORM: LinkedIn
- Use professional but warm tone appropriate for LinkedIn
- Reference their headline, role, company, or recent activity
- If connection degree is available, adjust warmth accordingly:
  - 1st degree: Reference existing connection, be warm
  - 2nd degree: Mention mutual connections if possible
  - 3rd degree: Be more formal, establish credibility first
- Reference specific skills or experience from their profile
- If this is a connection request note, keep it under 300 characters
- Avoid overly salesy language — LinkedIn users are sensitive to spam

`:t.platform==="x"?`PLATFORM: X (Twitter)
- Use conversational, authentic tone
- Reference their recent posts or tweets if available
- Keep it casual but purposeful

`:t.platform==="github"?`PLATFORM: GitHub
- Reference their projects, contributions, or tech stack
- Use developer-friendly language
- Be specific about technical interests

`:""}function We(t,s,n,r){const i=Object.entries(r).filter(([,d])=>d<70).sort((d,c)=>d[1]-c[1]).map(([d,c])=>`${d}: ${c}/100`);let o=`You are a voice-matching editor. A message was generated to match a specific voice profile, but scored ${n}/100 on voice matching.

GENERATED MESSAGE:
"${t}"

`;return i.length>0&&(o+=`WEAK DIMENSIONS (fix these):
${i.join(`
`)}

`),o+=`VOICE RULES TO FOLLOW:
${s.rules.map((d,c)=>`${c+1}. ${d}`).join(`
`)}

ANTI-PATTERNS TO AVOID:
${s.antiPatterns.map(d=>`✗ ${d}`).join(`
`)}

`,s.metrics&&(o+=`TARGET METRICS:
- Sentence length: aim for ~${s.metrics.sentenceLength.mean} words per sentence
- Formality: ${s.metrics.formalityScore}/100
- Contraction rate: ${s.metrics.contractionRate}% of sentences should use contractions
- Active voice: ${s.metrics.activeVoiceRate}%
${s.metrics.punctuation.exclamationRate>10?`- Use exclamation marks (${s.metrics.punctuation.exclamationRate}% of sentences)`:"- Avoid exclamation marks"}
${s.metrics.punctuation.questionRate>15?`- Include questions (${s.metrics.punctuation.questionRate}% of sentences)`:""}

`),s.exemplars&&s.exemplars.length>0&&(o+=`REFERENCE EXEMPLARS (match this style):
${s.exemplars.slice(0,2).map((d,c)=>`--- ${c+1} ---
${d.text}`).join(`

`)}

`),o+=`TASK: Rewrite the message to better match the voice profile. Fix the weak dimensions while keeping the same intent, recipient context, and call-to-action. The rewritten message should score 85+ on voice matching.

Return JSON (no markdown, no code blocks):
{
  "message": "rewritten message",
  "wordCount": number,
  "hook": "same hook as before",
  "voiceScore": 0-100,
  "changes": "brief description of what you changed and why"
}`,o}function X(t){const s=J(t);try{const r=JSON.parse(s);if(r.message)return r.message}catch{}const n=s.match(/"message"\s*:\s*"((?:[^"\\]|\\.)*)(?:"|$)/s);return n!=null&&n[1]?n[1].replace(/\\n/g,`
`).replace(/\\"/g,'"').replace(/\\\\/g,"\\").replace(/\\t/g,"	"):null}function Je(){const[t,s]=l.useState({}),[n,r]=l.useState({}),[i,o]=l.useState({}),[d,c]=l.useState({}),[h,f]=l.useState({}),[y,C]=l.useState("service"),[w,D]=l.useState(null),[S,x]=l.useState(0),j=W(p=>p.apiKey),R=W(p=>p.preferredModel),A=l.useRef(null),P=l.useRef(null),I=l.useRef(null),E=l.useRef(null),b=3;l.useEffect(()=>{const p=()=>{chrome.storage.local.get("voiceProfile",a=>{a.voiceProfile&&D(a.voiceProfile)})};p();const u=()=>p();return chrome.storage.onChanged.addListener(u),()=>chrome.storage.onChanged.removeListener(u)},[]);const L=l.useCallback(()=>{E.current&&(E.current.abort(),E.current=null)},[]),N=l.useCallback((p,u)=>{if(!(w!=null&&w.metrics)){f(a=>({...a,[u]:null}));return}try{const a=ve(p,w.metrics);f(v=>({...v,[u]:a}))}catch(a){console.warn("[useMessageGeneration] Voice match scoring failed:",a),f(v=>({...v,[u]:null}))}},[w]),O=l.useCallback(async(p,u,a)=>{if(!j)return;A.current=p,P.current=u,I.current=a,L();const v=new AbortController;E.current=v,o(T=>({...T,[a]:!0})),r(T=>({...T,[a]:""})),f(T=>({...T,[a]:null}));try{const T=W.getState().messageLength,V=Be(p,u,a,w||void 0,T);let F="";await te([{role:"system",content:"You are an expert outreach copywriter. You write personalized messages that sound authentically human — never generic, never AI-sounding. You follow the Hook→Bridge→Value→CTA structure precisely."},{role:"user",content:V}],j,{signal:v.signal,onChunk:M=>{F+=M;const k=X(F);k&&r(m=>({...m,[a]:k}));try{const m=J(F),g=JSON.parse(m);g.message&&g.wordCount&&(s($=>({...$,[a]:g})),r($=>({...$,[a]:""})),N(g.message,a))}catch{}},onComplete:M=>{try{const k=J(M),m=JSON.parse(k);s(g=>({...g,[a]:m})),r(g=>({...g,[a]:""})),o(g=>({...g,[a]:!1})),x(0),N(m.message,a)}catch{const k=X(M);if(k){const m={message:k,wordCount:k.split(/\s+/).filter(Boolean).length,hook:"",voiceScore:50};s(g=>({...g,[a]:m})),N(k,a)}r(m=>({...m,[a]:""})),o(m=>({...m,[a]:!1}))}E.current=null},onError:M=>{if(M instanceof DOMException&&M.name==="AbortError"){o(g=>({...g,[a]:!1})),r(g=>({...g,[a]:""}));return}const k=M instanceof Error?M.message:"Generation failed";if((k.includes("network")||k.includes("timeout")||k.includes("503")||k.includes("502"))&&S<b){x($=>$+1);const g=Math.pow(2,S)*1e3;setTimeout(()=>{A.current&&P.current&&I.current&&O(A.current,P.current,I.current)},g)}else o(g=>({...g,[a]:!1})),r(g=>({...g,[a]:""})),x(0);E.current=null}},R)}catch(T){if(T instanceof DOMException&&T.name==="AbortError"){o(V=>({...V,[a]:!1})),r(V=>({...V,[a]:""}));return}o(V=>({...V,[a]:!1})),r(V=>({...V,[a]:""})),E.current=null}},[j,w,S,L,N,R]),q=l.useCallback(async(p,u,a)=>{if(!j||!(w!=null&&w.metrics))return;const v=t[a],T=h[a];if(!v||!T)return;L();const V=new AbortController;E.current=V,c(F=>({...F,[a]:!0})),r(F=>({...F,[a]:""}));try{const F=We(v.message,w,T.score,T.breakdown);let M="";await te([{role:"system",content:"You are a voice-matching editor. You rewrite messages to better match a specific writing style while preserving the original intent and context."},{role:"user",content:F}],j,{signal:V.signal,onChunk:k=>{M+=k;const m=X(M);m&&r(g=>({...g,[a]:m}))},onComplete:k=>{try{const m=J(k),g=JSON.parse(m);s($=>({...$,[a]:g})),r($=>({...$,[a]:""})),c($=>({...$,[a]:!1})),N(g.message,a)}catch{const m=X(k);if(m){const g={message:m,wordCount:m.split(/\s+/).filter(Boolean).length,hook:v.hook,voiceScore:70};s($=>({...$,[a]:g})),N(m,a)}r(g=>({...g,[a]:""})),c(g=>({...g,[a]:!1}))}E.current=null},onError:k=>{if(k instanceof DOMException&&k.name==="AbortError"){c(m=>({...m,[a]:!1})),r(m=>({...m,[a]:""}));return}c(m=>({...m,[a]:!1})),r(m=>({...m,[a]:""})),E.current=null}},R)}catch{c(M=>({...M,[a]:!1})),r(M=>({...M,[a]:""})),E.current=null}},[j,w,t,h,L,N,R]),z=l.useCallback(async(p,u,a)=>{s(v=>({...v,[a]:null})),r(v=>({...v,[a]:""})),f(v=>({...v,[a]:null})),await O(p,u,a)},[O]);return{messages:t,streamingText:n,isGenerating:i,isRefining:d,voiceMatchScores:h,selectedAngle:y,setSelectedAngle:C,generateMessage:O,regenerateMessage:z,refineMessage:q,cancelGeneration:L,setMessages:s}}const re=l.createContext(void 0),se=l.forwardRef(({defaultValue:t,value:s,onValueChange:n,children:r,className:i},o)=>{const[d,c]=l.useState(t),h=s??d,f=y=>{s===void 0&&c(y),n==null||n(y)};return e.jsx(re.Provider,{value:{value:h,onValueChange:f},children:e.jsx("div",{ref:o,className:i,children:r})})});se.displayName="TabsRoot";const he=l.forwardRef(({children:t,className:s},n)=>e.jsx("div",{ref:n,role:"tablist","aria-orientation":"horizontal",className:H("inline-flex w-full items-center gap-0.5 rounded-lg bg-muted/40 p-0.5",s),children:t}));he.displayName="TabsList";const fe=l.forwardRef(({value:t,children:s,disabled:n=!1,className:r},i)=>{const o=l.useContext(re);if(!o)throw new Error("TabsTrigger must be used within TabsRoot");const{value:d,onValueChange:c}=o,h=d===t;return e.jsx("button",{ref:i,type:"button",disabled:n,role:"tab","aria-selected":h,"aria-controls":`panel-${t}`,id:`tab-${t}`,tabIndex:h?0:-1,onClick:()=>!n&&c(t),onKeyDown:f=>{var w,D,S,x,j,R,A;const y=Array.from(((w=f.currentTarget.parentElement)==null?void 0:w.querySelectorAll('[role="tab"]'))||[]),C=y.indexOf(f.currentTarget);switch(f.key){case"ArrowLeft":case"ArrowRight":f.preventDefault();const P=f.key==="ArrowLeft"?-1:1,I=(C+P+y.length)%y.length;(D=y[I])==null||D.focus(),(S=y[I])==null||S.click();break;case"Home":f.preventDefault(),(x=y[0])==null||x.focus(),(j=y[0])==null||j.click();break;case"End":f.preventDefault(),(R=y[y.length-1])==null||R.focus(),(A=y[y.length-1])==null||A.click();break;case"Enter":case" ":f.preventDefault(),f.currentTarget.click();break}},className:H("relative flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all duration-150 ease-in-out","focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:ring-offset-background","disabled:opacity-50 disabled:cursor-not-allowed",{"bg-card text-foreground shadow-xs":h,"text-muted-foreground hover:text-foreground":!h},r),children:s})});fe.displayName="TabsTrigger";const ge=l.forwardRef(({value:t,children:s,className:n},r)=>{const i=l.useContext(re);if(!i)throw new Error("TabsContent must be used within TabsRoot");const{value:o}=i;return o===t?e.jsx("div",{ref:r,role:"tabpanel",id:`panel-${t}`,"aria-labelledby":`tab-${t}`,tabIndex:0,className:n,children:s}):null});ge.displayName="TabsContent";const ee=Object.assign(se,{Root:se,List:he,Trigger:fe,Content:ge}),_e=["i hope this message finds you well","i wanted to reach out","i came across your","i was impressed by","i'd love to connect","i'd love to chat","i'd love to learn more","let me know if you'd be open","would you be open to","looking forward to connecting","looking forward to hearing","i believe there could be","i think there's a great opportunity","synergy","leverage","circle back","touch base","deep dive","game-changer","cutting-edge","innovative solution","value proposition","thought leader","paradigm shift","best-in-class","at the end of the day","in today's fast-paced","in the ever-evolving","it's worth noting","it goes without saying","needless to say","that being said","having said that","delve into","delve deeper","navigate the complexities","foster meaningful","cultivate","spearhead","revolutionize","streamline"],Ye=["i noticed that","i was particularly","i'm reaching out because","i'm writing to","as someone who","as a fellow","given your expertise","given your background","with your experience","based on your"];function Ke(t){if(t.length<50)return 50;const s=t.toLowerCase().split(/\s+/),r=new Set(s).size/s.length,i=new Set;let o=0;for(let f=0;f<s.length-1;f++)i.add(`${s[f]} ${s[f+1]}`),o++;const d=o>0?i.size/o:1,c=Math.max(0,Math.min(100,(.7-r)*200)),h=Math.max(0,Math.min(100,(.9-d)*300));return(c+h)/2}function Xe(t){const s=t.toLowerCase();let n=0;for(const r of _e)s.includes(r)&&n++;for(const r of Ye)s.includes(r)&&n++;return Math.min(100,n*25)}function Ze(t){const s=t.split(/[.!?]+/).filter(c=>c.trim().length>0);if(s.length<3)return 30;const n=s.map(c=>c.trim().split(/\s+/).length),r=n.reduce((c,h)=>c+h,0)/n.length,i=n.reduce((c,h)=>c+Math.pow(h-r,2),0)/n.length,o=Math.sqrt(i),d=r>0?o/r:0;return Math.max(0,Math.min(100,(.5-d)*200))}function Qe(t){const s=t.toLowerCase(),n=["perhaps","maybe","possibly","potentially","arguably","it seems","it appears","it's possible","one might","could potentially","might consider","worth exploring","i think","i believe","in my opinion","from my perspective"],r=s.split(/\s+/).length;let i=0;for(const d of n){const c=new RegExp(d,"g"),h=s.match(c);h&&(i+=h.length)}const o=i/r*100;return Math.min(100,o*30)}function et(t){if(!t||t.length<20)return{score:0,label:"Too short to analyze",breakdown:{compression:0,phrases:0,structure:0,hedging:0},suggestions:[]};const s=Ke(t),n=Xe(t),r=Ze(t),i=Qe(t),o=Math.round(s*.2+n*.4+r*.2+i*.2),d=Math.max(0,Math.min(100,o));let c;d<=20?c="Very human":d<=40?c="Mostly human":d<=60?c="Mixed":d<=80?c="Somewhat AI":c="Very AI";const h=[];return n>40&&h.push(`Remove generic AI phrases like "I hope this finds you well" or "I'd love to connect"`),r>50&&h.push("Vary your sentence lengths — mix short punchy sentences with longer ones"),i>40&&h.push('Reduce hedging words like "perhaps", "potentially", "might consider"'),s>50&&h.push("Use more specific, unique vocabulary instead of common generic terms"),{score:d,label:c,breakdown:{compression:s,phrases:n,structure:r,hedging:i},suggestions:h}}function tt(t){return t>=80?{label:"Sounds like you",variant:"success"}:t>=60?{label:"Close match",variant:"info"}:t>=40?{label:"Moderate match",variant:"warning"}:{label:"Generic tone",variant:"error"}}function st(t){return t<=20?{label:"Very human",color:"text-success"}:t<=40?{label:"Human",color:"text-info"}:t<=60?{label:"Mixed",color:"text-warning"}:{label:"AI-sounding",color:"text-destructive"}}const nt={sentenceLength:{label:"Rhythm",desc:"Sentence length pattern"},formality:{label:"Formality",desc:"Register & tone level"},contractions:{label:"Contractions",desc:"Contraction usage"},readability:{label:"Readability",desc:"Reading level match"},pronouns:{label:"Pronouns",desc:"I/you/we usage"},punctuation:{label:"Punctuation",desc:"Marks & emphasis"}};function rt({pageData:t,analysis:s,selectedAngle:n,onSelectAngle:r,onCopy:i,onRegenerate:o,onScheduleFollowUp:d}){const{messages:c,streamingText:h,isGenerating:f,isRefining:y,voiceMatchScores:C,generateMessage:w,regenerateMessage:D,refineMessage:S,setMessages:x}=Je(),[j,R]=l.useState(!1),[A,P]=l.useState(!1),[I,E]=l.useState(!1),b=c[n],L=h[n]||"",N=f[n],O=y[n],q=(N||O)&&L.length>0,z=C[n],p=b?et(b.message):null,u=p?st(p.score):null,a=(z==null?void 0:z.score)??(b==null?void 0:b.voiceScore)??0,v=b?tt(a):null,T=z&&z.score<70&&!O&&!N,V=m=>{r(m),!c[m]&&!f[m]&&w(t,s,m)},F=()=>{D(t,s,n),P(!1),E(!1),o&&o()},M=()=>{s&&(S(t,s,n),E(!1))},k=()=>{i&&b&&i(b.message)};return!b&&!N&&s&&w(t,s,n),e.jsxs(B,{variant:"default",children:[e.jsx(_,{children:e.jsx(Y,{children:"Message"})}),e.jsxs(U,{className:"space-y-3",children:[(s==null?void 0:s.outreachAngles)&&e.jsx(ee.Root,{defaultValue:n,value:n,onValueChange:V,children:e.jsx(ee.List,{children:s.outreachAngles.map(m=>e.jsx(ee.Trigger,{value:m.angle,children:m.angle.charAt(0).toUpperCase()+m.angle.slice(1)},m.angle))})}),N&&!b&&!q&&e.jsxs("div",{role:"status","aria-live":"polite","aria-label":"Generating message",className:"space-y-2.5 py-3",children:[e.jsx("div",{className:"h-2.5 bg-muted rounded-full w-full animate-pulse"}),e.jsx("div",{className:"h-2.5 bg-muted rounded-full w-5/6 animate-pulse"}),e.jsx("div",{className:"h-2.5 bg-muted rounded-full w-4/6 animate-pulse"}),e.jsx("div",{className:"h-2.5 bg-muted rounded-full w-full animate-pulse"}),e.jsx("div",{className:"h-2.5 bg-muted rounded-full w-3/5 animate-pulse"})]}),q&&!b&&e.jsxs("div",{className:"rounded-lg bg-background/50 p-3",children:[e.jsxs("p",{className:"text-[13px] text-foreground whitespace-pre-wrap leading-relaxed",children:[L,e.jsx("span",{className:"inline-block w-[2px] h-[14px] bg-primary ml-0.5 align-middle animate-blink"})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2 pt-2 border-t border-border/30",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-primary animate-pulse"}),e.jsxs("span",{className:"text-[10px] text-muted-foreground",children:[O?"Refining voice":"Generating"," · ",L.split(/\s+/).filter(Boolean).length,"w"]})]})]}),O&&q&&b&&e.jsxs("div",{className:"rounded-lg bg-background/50 p-3 border border-primary/20",children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-primary animate-pulse"}),e.jsx("span",{className:"text-[10px] text-primary font-medium",children:"Refining voice match..."})]}),e.jsxs("p",{className:"text-[13px] text-foreground whitespace-pre-wrap leading-relaxed",children:[L,e.jsx("span",{className:"inline-block w-[2px] h-[14px] bg-primary ml-0.5 align-middle animate-blink"})]})]}),b&&!O&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-lg bg-background/50 p-3",children:e.jsx("p",{className:"text-[13px] text-foreground whitespace-pre-wrap leading-relaxed",children:b.message})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2",children:v&&e.jsxs("button",{onClick:()=>E(!I),className:"flex items-center gap-1 group",children:[e.jsx(de,{variant:v.variant,size:"sm",children:v.label}),e.jsxs("span",{className:"text-[10px] text-muted-foreground tabular-nums",children:[a,"%"]}),e.jsx(je,{size:10,className:`text-muted-foreground/50 transition-transform ${I?"rotate-180":""}`})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[p&&u&&e.jsxs("button",{onClick:()=>P(!A),className:`flex items-center gap-1 text-[10px] ${u.color} hover:opacity-80 transition-opacity`,title:"AI-ness score — click for details",children:[e.jsx(ce,{size:10}),e.jsxs("span",{className:"tabular-nums",children:[p.score,"% AI"]})]}),e.jsx("span",{className:"text-[10px] text-muted-foreground/40",children:"·"}),e.jsxs("span",{className:"text-[10px] text-muted-foreground tabular-nums",children:[b.wordCount,"w"]})]})]}),I&&z&&e.jsxs("div",{className:"rounded-lg bg-background/50 border border-border/40 p-3 space-y-2 animate-in fade-in slide-in-from-top-1 duration-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[11px] font-medium text-foreground",children:"Voice Match Breakdown"}),e.jsxs("span",{className:`text-[11px] font-medium ${v?`text-${v.variant}`:"text-muted-foreground"}`,children:[z.score,"/100"]})]}),e.jsx("div",{className:"space-y-1.5",children:Object.entries(z.breakdown).map(([m,g])=>{const $=nt[m];return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-[70px] shrink-0",title:$.desc,children:$.label}),e.jsx("div",{className:"flex-1 h-1.5 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full transition-all duration-500 ${g>=70?"bg-success":g>=40?"bg-warning":"bg-destructive"}`,style:{width:`${Math.max(3,g)}%`}})}),e.jsx("span",{className:"text-[9px] text-muted-foreground/60 w-6 text-right tabular-nums",children:g})]},m)})}),T&&e.jsxs("div",{className:"pt-2 border-t border-border/30",children:[e.jsxs(G,{variant:"outline",size:"sm",onClick:M,className:"w-full text-[11px]",children:[e.jsx(ae,{size:11}),"Refine Voice Match (",z.score,"% → 85%+)"]}),e.jsx("p",{className:"text-[9px] text-muted-foreground/50 text-center mt-1",children:"Uses a second LLM pass to improve weak dimensions"})]})]}),A&&p&&e.jsxs("div",{className:"rounded-lg bg-background/50 border border-border/40 p-3 space-y-2 animate-in fade-in slide-in-from-top-1 duration-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[11px] font-medium text-foreground",children:"AI Detection Breakdown"}),e.jsx("span",{className:`text-[11px] font-medium ${u.color}`,children:p.label})]}),e.jsx("div",{className:"space-y-1.5",children:[{label:"Phrases",value:p.breakdown.phrases,desc:"Common AI phrases"},{label:"Structure",value:p.breakdown.structure,desc:"Sentence uniformity"},{label:"Hedging",value:p.breakdown.hedging,desc:"Qualifiers & hedges"},{label:"Vocab",value:p.breakdown.compression,desc:"Word diversity"}].map(({label:m,value:g,desc:$})=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-14 shrink-0",title:$,children:m}),e.jsx("div",{className:"flex-1 h-1.5 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full transition-all duration-300 ${g<=30?"bg-success":g<=60?"bg-warning":"bg-destructive"}`,style:{width:`${Math.max(2,g)}%`}})}),e.jsx("span",{className:"text-[9px] text-muted-foreground/60 w-6 text-right tabular-nums",children:g})]},m))}),p.suggestions.length>0&&e.jsxs("div",{className:"pt-2 border-t border-border/30",children:[e.jsx("p",{className:"text-[10px] font-medium text-muted-foreground mb-1",children:"Suggestions"}),e.jsx("ul",{className:"space-y-0.5",children:p.suggestions.map((m,g)=>e.jsxs("li",{className:"text-[10px] text-muted-foreground/70 flex gap-1.5",children:[e.jsx("span",{className:"shrink-0",children:"•"}),e.jsx("span",{children:m})]},g))})]})]}),b.hook&&e.jsxs("p",{className:"text-[11px] text-muted-foreground/70 italic leading-relaxed",children:["Hook: ",b.hook]}),e.jsx(Ve,{text:b.message,onCopy:k}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(G,{variant:"ghost",size:"sm",onClick:F,disabled:N||O,className:"flex-1",children:[e.jsx(ae,{size:13,className:N?"animate-spin":""}),"Regenerate"]}),e.jsxs(G,{variant:"ghost",size:"sm",onClick:()=>R(!0),className:"flex-1","aria-label":"Edit this message",children:[e.jsx(Te,{size:13}),"Edit"]})]}),d&&e.jsxs(G,{variant:"ghost",size:"sm",onClick:d,className:"w-full text-muted-foreground",children:[e.jsx(me,{size:13}),"Schedule Follow-ups"]})]})]}),j&&b&&e.jsx(De,{initialMessage:b.message,onSave:m=>{x(g=>({...g,[n]:{...b,message:m,wordCount:m.split(/\s+/).filter(Boolean).length}})),R(!1)},onClose:()=>R(!1)})]})}const at=l.memo(rt,(t,s)=>{var n,r,i,o,d,c,h,f;return t.pageData.url===s.pageData.url&&t.selectedAngle===s.selectedAngle&&((n=t.analysis)==null?void 0:n.personName)===((r=s.analysis)==null?void 0:r.personName)&&((i=t.analysis)==null?void 0:i.confidence)===((o=s.analysis)==null?void 0:o.confidence)&&((c=(d=t.analysis)==null?void 0:d.outreachAngles)==null?void 0:c.length)===((f=(h=s.analysis)==null?void 0:h.outreachAngles)==null?void 0:f.length)});function ot(t,s){return s?t==="x"?`https://x.com/messages/${s}`:t==="linkedin"?"https://www.linkedin.com/messaging/compose/":null:null}function it({isOpen:t,onClose:s,onLogged:n,platform:r,username:i}){const[o,d]=l.useState(!1);l.useEffect(()=>{t&&d(!0)},[t]);const c=l.useCallback(w=>{t&&(w.key==="Escape"?y():w.key==="Enter"&&f())},[t]);if(l.useEffect(()=>(document.addEventListener("keydown",c),()=>document.removeEventListener("keydown",c)),[c]),!t)return null;const h=ot(r,i),f=()=>{n(),d(!1),setTimeout(()=>s(),200)},y=()=>{d(!1),setTimeout(()=>s(),200)},C=()=>{h&&window.open(h,"_blank"),f()};return e.jsx("div",{className:`
        fixed inset-0 bg-background/60 backdrop-blur-sm flex items-end justify-center z-50
        transition-opacity duration-200
        ${o?"opacity-100":"opacity-0"}
      `,onClick:y,role:"dialog","aria-modal":"true","aria-label":"Log conversation",children:e.jsxs("div",{className:`
          w-full bg-card border-t border-border/60 rounded-t-2xl p-5 pb-6
          transition-transform duration-200 ease-out
          ${o?"translate-y-0":"translate-y-full"}
        `,onClick:w=>w.stopPropagation(),children:[e.jsx("div",{className:"w-8 h-1 bg-muted-foreground/20 rounded-full mx-auto mb-4"}),e.jsxs("div",{className:"flex flex-col items-center mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-success/10 flex items-center justify-center mb-2",children:e.jsx(Q,{size:18,className:"text-success"})}),e.jsx("p",{className:"text-sm font-medium text-foreground text-center",children:"Message copied"}),e.jsx("p",{className:"text-[11px] text-muted-foreground text-center mt-0.5",children:"Did you send it? We'll track it for you."})]}),e.jsxs("div",{className:"space-y-2",children:[h&&e.jsxs(G,{onClick:C,variant:"primary",size:"md",className:"w-full",children:[e.jsx(ue,{size:14}),"Open ",r==="x"?"X":"LinkedIn"," DM"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(G,{onClick:f,variant:h?"ghost":"primary",size:"md",className:"flex-1",children:[e.jsx(Q,{size:14}),"Sent it"]}),e.jsx(G,{onClick:y,variant:"ghost",size:"md",className:"flex-1",children:"Not yet"})]})]})]})})}function lt({value:t,max:s=100,size:n="md",variant:r,showValue:i=!1,label:o,color:d,className:c,...h}){const f=Math.min(Math.max(t/s*100,0),100),y=r||(f>=60?"success":f>=30?"warning":"error"),C={default:"bg-muted-foreground",success:"bg-success",warning:"bg-warning",error:"bg-destructive"},w={default:"text-muted-foreground",success:"text-success",warning:"text-warning",error:"text-destructive"};return e.jsxs("div",{className:H("space-y-2",c),...h,children:[(o||i)&&e.jsxs("div",{className:"flex items-center justify-between",children:[o&&e.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:o}),i&&e.jsxs("span",{className:H("text-xs font-semibold font-numerical tabular-nums",w[y]),children:[Math.round(f),"%"]})]}),e.jsx("div",{role:"progressbar","aria-valuenow":Math.round(f),"aria-valuemin":0,"aria-valuemax":100,className:H("w-full bg-muted rounded-full overflow-hidden",{"h-1":n==="sm","h-1.5":n==="md","h-2":n==="lg"}),children:e.jsx("div",{className:H("h-full rounded-full transition-all duration-500",d?"":C[y]),style:{width:`${f}%`,transitionTimingFunction:"cubic-bezier(0.4, 0.0, 0.2, 1)",...d&&{backgroundColor:d}}})})]})}function ct(){const[t,s]=l.useState(null),[n,r]=l.useState(!1),[i,o]=l.useState(!1),[d,c]=l.useState(0),[h,f]=l.useState(null),[y,C]=l.useState(0),w=W(b=>b.apiKey),D=W(b=>b.preferredModel),S=l.useRef(null),x=l.useRef(null),j=l.useRef(null),R=l.useRef(null),A=l.useRef(null),P=3,I=l.useCallback(()=>{A.current&&(A.current.abort(),A.current=null),S.current&&(clearTimeout(S.current),S.current=null),x.current&&(clearInterval(x.current),x.current=null),o(!1),c(0),r(!1),j.current=null},[]),E=l.useCallback(async b=>{if(!w){f("No API key configured");return}if(j.current===b.url&&(n||i))return;I(),j.current=b.url,R.current=b,o(!0),c(1),f(null);let L=1;x.current=setInterval(()=>{L--,c(L),L<=0&&x.current&&(clearInterval(x.current),x.current=null)},1e3),S.current=setTimeout(async()=>{o(!1),r(!0),s(null);try{const N=await Ne(b.url);if(N){s(N),r(!1),j.current=null;return}const O=new AbortController;A.current=O;const q=Ge(b);let z="";await te([{role:"system",content:"You are a helpful assistant that analyzes webpages for outreach purposes."},{role:"user",content:q}],w,{signal:O.signal,onChunk:p=>{z+=p;try{const u=J(z),a=JSON.parse(u);a.confidence&&s(a)}catch{}},onComplete:async p=>{try{const u=J(p),a=JSON.parse(u);s(a),await ke(b.url,a),C(0)}catch{f("Failed to parse analysis response")}r(!1),j.current=null,A.current=null},onError:p=>{if(p instanceof DOMException&&p.name==="AbortError")return;const u=p instanceof Error?p.message:"Analysis failed";if((u.includes("network")||u.includes("timeout")||u.includes("503")||u.includes("502"))&&y<P){C(T=>T+1);const v=Math.pow(2,y)*1e3;setTimeout(()=>{R.current&&E(R.current)},v)}else f(u),r(!1),j.current=null,A.current=null,C(0)}},D)}catch(N){if(N instanceof DOMException&&N.name==="AbortError")return;f(N instanceof Error?N.message:"Analysis failed"),r(!1),j.current=null,A.current=null}},1e3)},[w,n,i,I,y]);return{analysis:t,isAnalyzing:n,isDebouncing:i,debounceCountdown:d,error:h,analyzePage:E,cancelAnalysis:I}}function dt(t,s,n,r){const i=t.name||"this person",o=r==="linkedin"?"LinkedIn connection/message":r==="x"?"X/Twitter DM":"message";return{contactId:t.id,contactName:t.name,originalAngle:n,originalMessage:s,createdAt:Date.now(),messages:[{sequence:1,delay:"3 days",delayMs:4320*60*1e3,tone:"gentle",prompt:`Write a gentle follow-up ${o} to ${i}. 

Context: I previously sent this message:
"${s.slice(0,300)}"

The follow-up should:
- Be SHORT (2-3 sentences max)
- Reference the original message briefly without repeating it
- Add a small new insight or value point
- NOT be pushy or desperate
- Sound natural and human
- End with a soft call to action

Tone: Casual, friendly, brief. Like bumping a thread.`},{sequence:2,delay:"7 days",delayMs:10080*60*1e3,tone:"value-add",prompt:`Write a value-add follow-up ${o} to ${i}.

Context: I sent an initial outreach message about ${n}, and a gentle follow-up 3 days later. Neither got a response.

The follow-up should:
- Be 3-4 sentences
- Lead with NEW value (share a relevant insight, resource, or observation about their work)
- NOT reference the previous messages directly
- Feel like a fresh, helpful message rather than a "just checking in"
- Include something specific about their recent activity or content
- End with a low-pressure question

Tone: Helpful, knowledgeable, not salesy.`},{sequence:3,delay:"14 days",delayMs:336*60*60*1e3,tone:"final",prompt:`Write a final, graceful follow-up ${o} to ${i}.

Context: This is the third and final follow-up. Previous messages about ${n} went unanswered.

The follow-up should:
- Be 2 sentences MAX
- Acknowledge they're busy (without being passive-aggressive)
- Leave the door open for future connection
- NOT guilt-trip or be desperate
- Be memorable and classy

Tone: Respectful, brief, confident. Like closing a door gently.`}]}}async function ut(t){for(const s of t.messages){const n=`followup-${t.contactId}-${s.sequence}`,r=Date.now()+s.delayMs;try{await chrome.alarms.create(n,{when:r});const i=`followup_${t.contactId}_${s.sequence}`;await chrome.storage.local.set({[i]:{contactId:t.contactId,contactName:t.contactName,sequence:s.sequence,tone:s.tone,prompt:s.prompt,scheduledFor:r}}),await Z.touchpoints.add({contactId:t.contactId,type:"follow_up_scheduled",angle:t.originalAngle,message:`Follow-up #${s.sequence} (${s.tone}) scheduled for ${s.delay}`,platform:"system",timestamp:Date.now()})}catch(i){console.warn(`[follow-up] Failed to schedule alarm ${n}:`,i)}}}const mt=[{value:"short",label:"Short",desc:"40-80w"},{value:"medium",label:"Medium",desc:"100-150w"},{value:"long",label:"Long",desc:"180-250w"}];function vt({initialData:t}){const[s,n]=l.useState(t),[r,i]=l.useState(!t),[o,d]=l.useState("service"),[c,h]=l.useState(!1),[f,y]=l.useState(!1),[C,w]=l.useState(""),[D,S]=l.useState(null),{analysis:x,isAnalyzing:j,isDebouncing:R,debounceCountdown:A,error:P,analyzePage:I,cancelAnalysis:E}=ct(),b=W(u=>u.messageLength),L=W(u=>u.setMessageLength),{add:N}=pe();l.useEffect(()=>{const u=a=>{if(a.currentPageData){const v=a.currentPageData.newValue;n(v),i(!1),y(!1),S(null)}};return chrome.storage.session.onChanged.addListener(u),()=>chrome.storage.session.onChanged.removeListener(u)},[]),l.useEffect(()=>{(async()=>{if(s!=null&&s.url)try{const a=await Ce(s.url);if(a&&a.totalMessages>0){S(`You've already sent ${a.totalMessages} message${a.totalMessages>1?"s":""} to this contact.`);return}const v=await Z.conversations.where("pageUrl").equals(s.url).count();v>0?S(`You've already sent ${v} message${v>1?"s":""} to this page.`):S(null)}catch{}})()},[s==null?void 0:s.url]);const O=()=>{s&&!x&&!j&&!f&&(y(!0),I(s))},q=u=>{u&&w(u),setTimeout(()=>h(!0),100)},z=async()=>{if(!(!s||!C))try{await Z.conversations.add({id:`${Date.now()}-${Math.random().toString(36).slice(2,9)}`,platform:s.platform,pageUrl:s.url,pageName:(x==null?void 0:x.personName)||s.name||s.ogTitle||s.hostname,sentMessage:C,angle:o,sentAt:Date.now(),status:"sent"});try{const u=await le(s,x||void 0);await Se({contactId:u,type:"copied",angle:o,message:C,platform:s.platform,timestamp:Date.now(),messageLength:b})}catch(u){console.warn("[OutreachScreen] Failed to update contact:",u)}}catch(u){console.error("[OutreachScreen] Failed to log conversation:",u)}};if(r)return e.jsxs("div",{className:"space-y-3",children:[e.jsx(be,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-3 bg-muted rounded w-1/4"}),e.jsx("div",{className:"h-3 bg-muted rounded w-full"}),e.jsx("div",{className:"h-3 bg-muted rounded w-5/6"})]})]});if(!s)return e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-[13px] leading-relaxed text-muted-foreground",children:"Waiting for page data..."})});const p=s.isProfile||s.name;return e.jsxs("div",{className:"space-y-3",children:[p?e.jsx(Ie,{data:s}):e.jsx(Oe,{data:s}),s.isThread&&s.threadContext&&s.threadContext.length>0&&e.jsx(B,{variant:"default",children:e.jsxs(U,{className:"p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1.5",children:[e.jsx(Ee,{size:13,className:"text-info"}),e.jsxs("span",{className:"text-[11px] font-medium text-foreground",children:["Thread detected · ",s.threadContext.length," messages"]})]}),e.jsx("p",{className:"text-[11px] text-muted-foreground leading-relaxed",children:"Thread context will be used to generate more relevant messages."})]})}),D&&e.jsx(ie,{variant:"warning",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{size:14,className:"shrink-0"}),e.jsx("span",{children:D})]})}),P&&e.jsx(ie,{variant:"error",children:P}),s&&!x&&!j&&!R&&!f&&e.jsx(B,{variant:"default",children:e.jsxs(U,{className:"p-5 text-center",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-3",children:e.jsx(ce,{size:18,className:"text-primary"})}),e.jsx("p",{className:"text-sm font-medium text-foreground mb-1",children:"Ready to analyze"}),e.jsxs("p",{className:"text-xs text-muted-foreground mb-4",children:["Generate personalized outreach for"," ",e.jsx("span",{className:"text-foreground font-medium",children:s.name||s.ogTitle||s.hostname})]}),e.jsx(G,{onClick:O,variant:"primary",size:"md",className:"w-full",children:"Analyze This Page"})]})}),R&&e.jsx(B,{variant:"default",children:e.jsxs(U,{className:"p-4 text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-info animate-pulse"}),e.jsx("span",{className:"text-xs font-medium text-foreground",children:"Starting analysis..."})]}),e.jsxs("p",{className:"text-[11px] text-muted-foreground",children:["Analyzing in ",A,"s"]}),e.jsx(G,{onClick:E,variant:"ghost",size:"xs",className:"mt-2",children:"Cancel"})]})}),j&&!x&&e.jsx(B,{variant:"default",children:e.jsxs(U,{className:"p-4 text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-info animate-pulse"}),e.jsx("span",{className:"text-xs font-medium text-foreground",children:"Analyzing page..."})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"h-2 bg-muted rounded-full w-full animate-pulse"}),e.jsx("div",{className:"h-2 bg-muted rounded-full w-3/4 animate-pulse"})]})]})}),x&&e.jsxs(e.Fragment,{children:[e.jsxs(B,{variant:"default",children:[e.jsx(_,{children:e.jsx(Y,{children:"Confidence"})}),e.jsxs(U,{children:[e.jsx(lt,{value:x.confidence,showValue:!0,size:"md"}),x.confidenceReason&&e.jsx("p",{className:"text-[11px] leading-relaxed text-muted-foreground mt-2",children:x.confidenceReason})]})]}),x.summary&&e.jsxs(B,{variant:"default",children:[e.jsx(_,{children:e.jsx(Y,{children:"Summary"})}),e.jsx(U,{children:e.jsx("p",{className:"text-[13px] leading-relaxed text-muted-foreground",children:x.summary})})]}),x.interests&&x.interests.length>0&&e.jsxs(B,{variant:"default",children:[e.jsx(_,{children:e.jsx(Y,{children:"Interests"})}),e.jsx(U,{children:e.jsx("div",{className:"flex flex-wrap gap-1.5",children:x.interests.map((u,a)=>e.jsx(de,{variant:"outline",size:"sm",children:u},a))})})]}),e.jsxs(B,{variant:"default",children:[e.jsx(_,{children:e.jsx(Y,{children:"Message Length"})}),e.jsx(U,{children:e.jsx("div",{className:"flex rounded-lg bg-muted/50 p-0.5 gap-0.5",children:mt.map(u=>e.jsxs("button",{onClick:()=>L(u.value),className:`flex-1 py-1.5 px-2 rounded-md text-center transition-all duration-200 ${b===u.value?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"}`,children:[e.jsx("span",{className:"text-[11px] font-medium block",children:u.label}),e.jsx("span",{className:"text-[9px] opacity-60 block",children:u.desc})]},u.value))})})]})]}),x&&s&&e.jsx(at,{pageData:s,analysis:x,selectedAngle:o,onSelectAngle:d,onCopy:q,onScheduleFollowUp:async()=>{if(!s||!C){N({title:"Copy a message first",variant:"error"});return}try{const u=await le(s,x||void 0),a=await Z.contacts.get(u);if(!a)return;const v=dt(a,C,o,s.platform);await ut(v),N({title:"Follow-ups scheduled",description:"3 reminders: 3d, 7d, 14d",variant:"success"})}catch(u){console.error("[OutreachScreen] Failed to schedule follow-ups:",u),N({title:"Failed to schedule follow-ups",variant:"error"})}}}),e.jsx(it,{isOpen:c,onClose:()=>h(!1),onLogged:z,platform:s.platform,username:s.username})]})}export{vt as default};
