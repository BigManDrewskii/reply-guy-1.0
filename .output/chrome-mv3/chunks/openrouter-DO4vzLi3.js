import{d as p}from"./badge-CmSeivz9.js";const N=["google/gemini-2.0-flash-001","anthropic/claude-3.5-haiku","openai/gpt-4o-mini"],m=N,L=1440*60*1e3;async function I(t,e,D={},a){var w,E,A,C,b;const{onChunk:y,onComplete:i,onError:s,signal:n}=D;let c=[...m];a&&c.includes(a)&&(c=[a,...c.filter(o=>o!==a)]);let h=null;for(const o of c)try{if(n!=null&&n.aborted)throw new DOMException("Aborted","AbortError");const r=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json","HTTP-Referer":(w=chrome.runtime)!=null&&w.id?`chrome-extension://${chrome.runtime.id}`:"chrome-extension://reply-guy","X-Title":"Reply Guy"},body:JSON.stringify({model:o,messages:t,stream:!0,temperature:.7,max_tokens:2e3,data_collection:"deny"}),signal:n});if(!r.ok){const u=await r.text().catch(()=>"");throw new Error(`OpenRouter API error (${o}): ${r.status} ${u}`)}const l=(E=r.body)==null?void 0:E.getReader();if(!l)throw new Error("No response body");const k=new TextDecoder;let f="";try{for(;;){if(n!=null&&n.aborted)throw l.cancel(),new DOMException("Aborted","AbortError");const{done:u,value:T}=await l.read();if(u)break;const g=k.decode(T).split(`
`);for(const x of g)if(x.startsWith("data: ")){const O=x.slice(6);if(O==="[DONE]"){i&&i(f);return}try{const d=(b=(C=(A=JSON.parse(O).choices)==null?void 0:A[0])==null?void 0:C.delta)==null?void 0:b.content;d&&(f+=d,y&&y(d))}catch{}}}}finally{l.releaseLock()}i&&i(f);return}catch(r){if(r instanceof DOMException&&r.name==="AbortError"){s&&s(r);return}if(h=r instanceof Error?r:new Error("Unknown error"),o===m[m.length-1])if(s)s(new Error(`All models failed. Last error: ${h.message}`));else throw h}}function R(t){return Date.now()-t<L}async function W(t){try{const e=await p.analysisCache.get(t);return e&&R(e.timestamp)?e.analysis:(e&&await p.analysisCache.delete(t),null)}catch{return null}}async function J(t,e){try{await p.analysisCache.put({pageUrl:t,analysis:e,timestamp:Date.now()})}catch{}}function M(t){let e=t.trim();return e.startsWith("```json")?e=e.slice(7):e.startsWith("```")&&(e=e.slice(3)),e.endsWith("```")&&(e=e.slice(0,-3)),e.trim()}export{N as M,J as a,M as e,W as g,I as s};
