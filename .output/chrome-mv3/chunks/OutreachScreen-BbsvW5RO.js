import{c as D,r as o,j as e,C as _,a as A,b as B,X as q,u as H,R as ee,I as F}from"./sidepanel-DOESzR4q.js";import{P as U}from"./icons-nDqOInjC.js";import{C as T,a as E}from"./card-CmhX-YKG.js";import{L as se,B as I}from"./button-CxHTzYgu.js";import{E as te}from"./external-link-CgoYwNyC.js";import{B as O}from"./badge-lIBAfX3c.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=D("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=D("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=D("Globe",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=D("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=D("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]),V=o.forwardRef(({className:t,src:s,alt:n,fallback:r,size:a="md",variant:l="circle",status:m,loading:p=!1,error:x=!1,...c},d)=>{const[i,y]=o.useState(!1),f={xs:"w-5 h-5 text-xs",sm:"w-8 h-8 text-xs",md:"w-9 h-9 text-sm",lg:"w-12 h-12 text-base",xl:"w-16 h-16 text-lg"},h={xs:10,sm:12,md:14,lg:16,xl:18}[a],j={online:"hsl(var(--success))",offline:"hsl(var(--muted-foreground))",away:"hsl(var(--warning))",busy:"hsl(var(--destructive))"},k=x||i;return e.jsxs("div",{ref:d,className:A("relative inline-flex flex-shrink-0",f[a],t),...c,children:[e.jsxs("div",{className:A("relative inline-flex items-center justify-center overflow-hidden","bg-card text-card-foreground font-semibold",{"rounded-full":l==="circle","rounded-lg":l==="square"}),children:[p&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-card/50 backdrop-blur-sm",children:e.jsx(se,{size:h,className:"animate-spin text-muted-foreground"})}),!k&&s?e.jsx("img",{src:s,alt:n||"",className:"w-full h-full object-cover",onError:()=>y(!0)}):k&&!r?e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-destructive/10",children:e.jsx(_,{size:h,className:"text-destructive"})}):e.jsx("span",{"aria-label":n||r||"Avatar",children:r})]}),m&&e.jsx("span",{className:A("absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full ring-2 ring-background","border-2 border-background"),style:{backgroundColor:j[m]},role:"status","aria-label":`Status: ${m}`})]})});V.displayName="Avatar";function ie({data:t}){var n,r;U[t.platform]||U.generic;const s=a=>a||"";return e.jsx(T,{variant:"default",className:"hover:scale-[1.02] hover:border-border/80",children:e.jsxs(E,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[e.jsx(V,{src:t.avatarUrl,fallback:((n=t.name)==null?void 0:n.charAt(0).toUpperCase())||((r=t.ogTitle)==null?void 0:r.charAt(0).toUpperCase())||"?",size:"md",variant:"circle"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h2",{className:"text-base font-semibold text-foreground truncate",children:t.name||t.ogTitle||t.title}),t.headline&&e.jsx("p",{className:"text-sm text-muted-foreground mt-0.5 line-clamp-2",children:t.headline}),(t.location||t.company)&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1 font-mono",children:[t.location,t.company].filter(Boolean).join(" · ")}),t.followers&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-0.5 font-numerical",children:[s(t.followers)," followers"]})]})]}),t.bio&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3 mb-3",children:t.bio}),t.about&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3 mb-3",children:t.about}),t.recentPosts&&t.recentPosts.length>0&&e.jsxs("div",{className:"border-t border-border pt-3 mt-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Recent posts"}),e.jsx("div",{className:"space-y-2",children:t.recentPosts.slice(0,3).map((a,l)=>e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2",children:a},l))})]})]})})}const ce=o.memo(ie,(t,s)=>t.data.name===s.data.name&&t.data.headline===s.data.headline&&t.data.bio===s.data.bio);function de({data:t}){return e.jsx(T,{variant:"default",children:e.jsxs(E,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[e.jsx(V,{fallback:e.jsx(ae,{size:20}),size:"md",variant:"circle"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h2",{className:"text-base font-semibold text-foreground truncate",children:t.hostname}),t.ogTitle&&e.jsx("p",{className:"text-sm text-muted-foreground mt-0.5 line-clamp-2",children:t.ogTitle}),!t.ogTitle&&t.h1&&e.jsx("p",{className:"text-sm text-muted-foreground mt-0.5 line-clamp-2",children:t.h1})]})]}),t.ogDescription&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3 mb-3",children:t.ogDescription}),t.socialLinks&&t.socialLinks.length>0&&e.jsxs("div",{className:"border-t border-border pt-3 mt-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Detected social links"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:t.socialLinks.map((s,n)=>e.jsxs("a",{href:s,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-primary hover:underline inline-flex items-center gap-1",children:[new URL(s).hostname,e.jsx(te,{size:12})]},n))})]}),t.email&&e.jsxs("div",{className:"border-t border-border pt-3 mt-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Contact"}),e.jsx("a",{href:`mailto:${t.email}`,className:"text-sm text-primary hover:underline",children:t.email})]})]})})}const ue=o.memo(de,(t,s)=>t.data.hostname===s.data.hostname&&t.data.ogTitle===s.data.ogTitle&&t.data.ogDescription===s.data.ogDescription);function me({text:t,onCopy:s}){const[n,r]=o.useState(!1),a=async()=>{try{await navigator.clipboard.writeText(t),r(!0),s&&s(),setTimeout(()=>r(!1),1e3)}catch(l){console.error("Failed to copy:",l)}};return e.jsx(I,{variant:n?"success":"primary",onClick:a,"aria-label":n?"Copied!":"Copy to clipboard",className:"w-full",children:n?e.jsxs(e.Fragment,{children:[e.jsx(B,{size:16}),"Copied"]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{size:16}),"Copy Message"]})})}const fe=o.memo(me,(t,s)=>t.text===s.text);function xe({initialMessage:t,onSave:s,onClose:n}){const[r,a]=o.useState(t),l=r.split(/\s+/).filter(Boolean).length,m=!r.trim()||r===t;return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-end justify-center z-50",children:e.jsx(T,{className:"w-full max-w-md rounded-t-lg animate-slide-up",children:e.jsxs(E,{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-base font-semibold",children:"Edit Message"}),e.jsx("button",{onClick:n,className:"text-muted-foreground hover:text-foreground","aria-label":"Close editor",children:e.jsx(q,{size:18})})]}),e.jsx("textarea",{value:r,onChange:p=>a(p.target.value),className:"w-full h-48 px-3 py-2 rounded-lg bg-card border border-border text-sm text-foreground resize-none focus:outline-none focus:ring-2 focus:ring-primary",placeholder:"Edit your message...","aria-label":"Edit message content"}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right font-numerical",children:[l," words"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(I,{onClick:n,variant:"secondary",size:"md",className:"flex-1",children:"Cancel"}),e.jsxs(I,{onClick:()=>s(r),variant:"primary",size:"md",className:"flex-1",disabled:m,children:[e.jsx(B,{size:16,className:"mr-2"}),"Save Changes"]})]})]})})})}function he(t){return`You analyze webpages to help craft personalized outreach messages.

PAGE DATA:
${JSON.stringify(t,null,2)}

Return JSON in this exact format (no markdown, no code blocks, just raw JSON):
{
  "personName": "best guess — person name or page/company name",
  "summary": "2-3 sentences about who this is and what they do",
  "interests": ["3-5 topics based on available evidence"],
  "outreachAngles": [
    { "angle": "service", "hook": "specific reason", "relevance": "why now" },
    { "angle": "partner", "hook": "...", "relevance": "..." },
    { "angle": "community", "hook": "...", "relevance": "..." },
    { "angle": "value", "hook": "...", "relevance": "..." }
  ],
  "confidence": 0-100,
  "confidenceReason": "based on data quality"
}

Rules:
- If data is sparse, confidence should be lower but ALWAYS provide angles
- Work with whatever context you have. Never refuse.
- For generic sites, focus on what IS visible (title, meta, content)
- interests must be specific topics, not generic phrases
- Each angle must have a unique hook based on actual page content
- confidenceReason should explain the rating`}function ge(t,s,n,r){let a=`Generate a personalized outreach message based on:

PAGE DATA:
${JSON.stringify(t,null,2)}

ANALYSIS:
${JSON.stringify(s,null,2)}

SELECTED ANGLE: ${n}

`;return r&&(a+=`
VOICE PROFILE (match this tone and style):
- Tone: ${r.tone}/10
- Opening patterns: ${r.openingPatterns.join(", ")}
- Personality markers: ${r.personalityMarkers.join(", ")}
- Avoid: ${r.avoidPhrases.join(", ")}

`),a+=`Return JSON in this exact format (no markdown, no code blocks, just raw JSON):
{
  "message": "personalized message 100-150 words",
  "wordCount": number,
  "hook": "why this approach works",
  "voiceScore": 0-100
}

Rules:
- Message must be 100-150 words
- Start with a natural, conversational opening
- Reference specific details from the page/analysis
- End with clear call-to-action
- Make it sound authentic, not AI-generated
- voiceScore reflects how well it matches the requested style`,a}const pe=1440*60*1e3;async function K(t,s,n={}){var m,p,x,c,d;const{onChunk:r,onComplete:a,onError:l}=n;try{const i=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json","HTTP-Referer":((m=chrome.runtime)==null?void 0:m.id)||"chrome-extension://reply-guy","X-Title":"Reply Guy"},body:JSON.stringify({model:"anthropic/claude-sonnet-4",messages:t,stream:!0,temperature:.7,max_tokens:2e3})});if(!i.ok)throw new Error(`OpenRouter API error: ${i.status}`);const y=(p=i.body)==null?void 0:p.getReader();if(!y)throw new Error("No response body");const f=new TextDecoder;let h="";for(;;){const{done:j,value:k}=await y.read();if(j)break;const C=f.decode(k).split(`
`);for(const g of C)if(g.startsWith("data: ")){const b=g.slice(6);if(b==="[DONE]"){a&&a(h);return}try{const N=(d=(c=(x=JSON.parse(b).choices)==null?void 0:x[0])==null?void 0:c.delta)==null?void 0:d.content;N&&(h+=N,r&&r(N))}catch{}}}a&&a(h)}catch(i){if(l)l(i instanceof Error?i:new Error("Unknown error"));else throw i}}function be(t){return Date.now()-t<pe}async function je(t){return new Promise(s=>{chrome.storage.local.get(`analysis_${t}`,n=>{const r=n[`analysis_${t}`];r&&be(r.timestamp)?s(r.analysis):s(null)})})}async function ye(t,s){return new Promise(n=>{chrome.storage.local.set({[`analysis_${t}`]:{analysis:s,timestamp:Date.now()}},()=>n())})}function Ne(){const[t,s]=o.useState({}),[n,r]=o.useState({}),[a,l]=o.useState("service"),[m,p]=o.useState(null),[x,c]=o.useState(0),d=H(u=>u.apiKey),i=o.useRef(null),y=o.useRef(null),f=o.useRef(null),h=3;o.useEffect(()=>{const u=()=>{chrome.storage.local.get("voiceProfile",g=>{g.voiceProfile&&p(g.voiceProfile)})};u();const C=()=>u();return chrome.storage.onChanged.addListener(C),()=>chrome.storage.onChanged.removeListener(C)},[]);const j=o.useCallback(async(u,C,g)=>{if(!d){console.error("No API key configured");return}i.current=u,y.current=C,f.current=g,r(b=>({...b,[g]:!0}));try{const b=ge(u,C,g,m||void 0);let z="";await K([{role:"system",content:"You are a helpful assistant that generates personalized outreach messages."},{role:"user",content:b}],d,{onChunk:N=>{z+=N;try{let w=z;const R=w.match(/```(?:json)?\s*([\s\S]*?)```/);R&&(w=R[1]);const S=JSON.parse(w);S.message&&s(v=>({...v,[g]:S}))}catch{}},onComplete:N=>{try{let w=N;const R=w.match(/```(?:json)?\s*([\s\S]*?)```/);R&&(w=R[1]);const S=JSON.parse(w);s(v=>({...v,[g]:S})),r(v=>({...v,[g]:!1})),c(0)}catch(w){console.error("Failed to parse message response:",w),r(R=>({...R,[g]:!1}))}},onError:N=>{const w=N instanceof Error?N.message:"Generation failed";if((w.includes("network")||w.includes("timeout")||w.includes("503")||w.includes("502"))&&x<h){console.log(`[useMessageGeneration] Retrying (${x+1}/${h})...`),c(v=>v+1);const S=Math.pow(2,x)*1e3;setTimeout(()=>{i.current&&y.current&&f.current&&j(i.current,y.current,f.current)},S)}else console.error("[useMessageGeneration] Generation error:",{error:N,angle:g,pageUrl:u.url,timestamp:new Date().toISOString(),retries:x}),r(S=>({...S,[g]:!1})),c(0)}})}catch(b){console.error("[useMessageGeneration] Unexpected error:",{error:b,angle:g,pageUrl:u.url,timestamp:new Date().toISOString()}),r(z=>({...z,[g]:!1}))}},[d,m,x]),k=o.useCallback(async(u,C,g)=>{s(b=>({...b,[g]:null})),await j(u,C,g)},[j]);return{messages:t,isGenerating:n,selectedAngle:a,setSelectedAngle:l,generateMessage:j,regenerateMessage:k,setMessages:s}}const J=o.createContext(void 0),G=o.forwardRef(({defaultValue:t,value:s,onValueChange:n,children:r,className:a},l)=>{const[m,p]=o.useState(t),x=s??m,c=d=>{s===void 0&&p(d),n==null||n(d)};return e.jsx(J.Provider,{value:{value:x,onValueChange:c},children:e.jsx("div",{ref:l,className:a,children:r})})});G.displayName="TabsRoot";const W=o.forwardRef(({children:t,className:s},n)=>e.jsx("div",{ref:n,role:"tablist","aria-orientation":"horizontal",className:A("relative inline-flex items-center gap-1 rounded-lg bg-muted/50 border border-border/50 p-1",s),children:t}));W.displayName="TabsList";const Y=o.forwardRef(({value:t,children:s,disabled:n=!1,className:r},a)=>{const l=o.useContext(J);if(!l)throw new Error("TabsTrigger must be used within TabsRoot");const{value:m,onValueChange:p}=l,x=m===t;return e.jsx("button",{ref:a,type:"button",disabled:n,role:"tab","aria-selected":x,"aria-controls":`panel-${t}`,id:`tab-${t}`,tabIndex:x?0:-1,onClick:()=>!n&&p(t),onKeyDown:c=>{var y,f,h,j,k,u,C;const d=Array.from(((y=c.currentTarget.parentElement)==null?void 0:y.querySelectorAll('[role="tab"]'))||[]),i=d.indexOf(c.currentTarget);switch(c.key){case"ArrowLeft":case"ArrowRight":c.preventDefault();const g=c.key==="ArrowLeft"?-1:1,b=(i+g+d.length)%d.length;(f=d[b])==null||f.focus(),(h=d[b])==null||h.click();break;case"Home":c.preventDefault(),(j=d[0])==null||j.focus(),(k=d[0])==null||k.click();break;case"End":c.preventDefault(),(u=d[d.length-1])==null||u.focus(),(C=d[d.length-1])==null||C.click();break;case"Enter":case" ":c.preventDefault(),c.currentTarget.click();break}},className:A("relative px-4 py-2 rounded-md font-medium text-sm transition-all duration-150 ease-in-out","focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background","disabled:opacity-50 disabled:cursor-not-allowed",{"bg-primary text-primary-foreground":x,"text-muted-foreground hover:text-foreground hover:bg-card/50":!x},r),children:s})});Y.displayName="TabsTrigger";const X=o.forwardRef(({value:t,children:s,className:n},r)=>{const a=o.useContext(J);if(!a)throw new Error("TabsContent must be used within TabsRoot");const{value:l}=a;return l===t?e.jsx("div",{ref:r,role:"tabpanel",id:`panel-${t}`,"aria-labelledby":`tab-${t}`,tabIndex:0,className:n,children:s}):null});X.displayName="TabsContent";const P=Object.assign(G,{Root:G,List:W,Trigger:Y,Content:X});function ve({pageData:t,analysis:s,selectedAngle:n,onSelectAngle:r,onCopy:a,onRegenerate:l}){const{messages:m,isGenerating:p,generateMessage:x,regenerateMessage:c,setMessages:d}=Ne(),[i,y]=o.useState(!1),f=m[n],h=p[n],j=u=>{r(u),!m[u]&&!p[u]&&x(t,s,u)},k=()=>{c(t,s,n),l&&l()};return!f&&!h&&x(t,s,n),e.jsxs(T,{variant:"default",className:"space-y-4",children:[e.jsxs(E,{className:"space-y-4",children:[(s==null?void 0:s.outreachAngles)&&e.jsx(P.Root,{defaultValue:n,value:n,onValueChange:j,children:e.jsx(P.List,{children:s.outreachAngles.map(u=>e.jsx(P.Trigger,{value:u.angle,children:u.angle.charAt(0).toUpperCase()+u.angle.slice(1)},u.angle))})}),h&&!f&&e.jsxs("div",{role:"status","aria-live":"polite","aria-label":"Generating message",className:"space-y-3 py-4",children:[e.jsx("div",{className:"h-3 bg-muted rounded w-full animate-pulse"}),e.jsx("div",{className:"h-3 bg-muted rounded w-5/6 animate-pulse"}),e.jsx("div",{className:"h-3 bg-muted rounded w-4/6 animate-pulse"})]}),f&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm text-foreground whitespace-pre-wrap leading-relaxed",children:f.message}),e.jsx("div",{className:"flex items-center justify-between text-xs text-muted-foreground pt-3 border-t border-border",children:e.jsxs("span",{className:"font-numerical",children:["Voice: ",f.voiceScore,"% · ",f.wordCount,"w"]})}),f.hook&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Hook: ",f.hook]}),e.jsx(fe,{text:f.message,onCopy:a})]}),f&&e.jsxs("div",{className:"flex gap-2 pt-3 border-t border-border",children:[e.jsxs(I,{variant:"secondary",size:"sm",onClick:k,disabled:h,className:"flex-1",children:[e.jsx(ee,{size:14}),"Regenerate"]}),e.jsxs(I,{variant:"ghost",size:"sm",onClick:()=>y(!0),className:"flex-1","aria-label":"Edit this message",children:[e.jsx(oe,{size:14}),"Edit"]})]})]}),i&&f&&e.jsx(xe,{initialMessage:f.message,onSave:u=>{d(C=>({...C,[n]:{...f,message:u,wordCount:u.split(/\s+/).filter(Boolean).length}})),y(!1)},onClose:()=>y(!1)})]})}const we=o.memo(ve,(t,s)=>{var n,r,a,l;return t.pageData.url===s.pageData.url&&t.selectedAngle===s.selectedAngle&&((n=t.analysis)==null?void 0:n.personName)===((r=s.analysis)==null?void 0:r.personName)&&((a=t.analysis)==null?void 0:a.summary)===((l=s.analysis)==null?void 0:l.summary)});function Ce({isOpen:t,onClose:s,onLogged:n}){const[r,a]=o.useState(!1);if(o.useEffect(()=>{t&&a(!0)},[t]),!t)return null;const l=()=>{n(),a(!1),setTimeout(()=>s(),300)},m=()=>{a(!1),setTimeout(()=>s(),300)};return e.jsx("div",{className:`
        fixed inset-0 bg-black/50 flex items-end justify-center z-50
        transition-opacity duration-300
        ${r?"opacity-100":"opacity-0"}
      `,onClick:m,children:e.jsxs("div",{className:`
          w-full max-w-md bg-card border-t border-border rounded-t-lg p-6
          transition-transform duration-300
          ${r?"translate-y-0":"translate-y-full"}
        `,onClick:p=>p.stopPropagation(),children:[e.jsx("p",{className:"text-sm text-foreground text-center mb-6",children:"Did you send this?"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(I,{onClick:l,variant:"success",size:"md",className:"flex-1",children:[e.jsx(B,{size:16,className:"mr-2"}),"Sent"]}),e.jsxs(I,{onClick:m,variant:"secondary",size:"md",className:"flex-1",children:[e.jsx(q,{size:16,className:"mr-2"}),"Cancel"]})]})]})})}function M({className:t,variant:s="pulse"}){const n=A("skeleton-shimmer animate-shimmer","bg-[length:200%_100%]"),r={pulse:"rounded-lg",text:"rounded h-4 w-full",avatar:"rounded-full"};return e.jsx("div",{role:"status","aria-label":"Loading content",className:A(n,r[s],t)})}function ke(){return e.jsxs("div",{className:"space-y-4","data-testid":"profile-card-skeleton",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(M,{variant:"avatar",className:"h-12 w-12 shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(M,{variant:"text",className:"w-3/4"}),e.jsx(M,{variant:"text",className:"w-1/2"})]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(M,{variant:"pulse",className:"h-8 flex-1"}),e.jsx(M,{variant:"pulse",className:"h-8 flex-1"}),e.jsx(M,{variant:"pulse",className:"h-8 flex-1"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{variant:"text",className:"w-full"}),e.jsx(M,{variant:"text",className:"w-5/6"}),e.jsx(M,{variant:"text",className:"w-2/3"})]})]})}const Q=o.forwardRef(({className:t,variant:s="default",title:n,action:r,children:a,...l},m)=>{const x={default:F,error:_,warning:le,info:F,success:re}[s];return e.jsx("div",{ref:m,role:"alert","aria-live":s==="error"?"assertive":"polite","aria-atomic":"true",className:A("border rounded-lg p-4 relative",{"border-border bg-card":s==="default","border-destructive bg-card":s==="error","border-warning bg-card":s==="warning","border-info bg-card":s==="info","border-success bg-card":s==="success"},t),...l,children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:A("flex-shrink-0",{"text-muted-foreground":s==="default","text-destructive":s==="error","text-warning":s==="warning","text-info":s==="info","text-success":s==="success"}),children:e.jsx(x,{size:18})}),e.jsxs("div",{className:"flex-1 space-y-1",children:[n&&e.jsx("div",{className:"font-semibold text-sm text-foreground",children:n}),e.jsx("div",{className:A("text-sm",{"text-muted-foreground":s==="default","text-destructive":s==="error","text-warning":s==="warning","text-info":s==="info","text-success":s==="success"}),children:a}),r&&e.jsx("button",{onClick:r.onClick,className:A("text-sm font-medium underline underline-offset-2 hover:no-underline",{"text-primary":s==="default","text-destructive":s==="error","text-warning":s==="warning","text-info":s==="info","text-success":s==="success"}),children:r.label})]})]})})});Q.displayName="Alert";function Se({value:t,max:s=100,size:n="md",variant:r,showValue:a=!1,label:l,color:m,className:p,...x}){const c=Math.min(Math.max(t/s*100,0),100),d=r||(c>=60?"success":c>=30?"warning":"error"),i={default:"bg-muted-foreground",success:"bg-success",warning:"bg-warning",error:"bg-destructive"};return e.jsxs("div",{className:A("space-y-2",p),...x,children:[(l||a)&&e.jsxs("div",{className:"flex items-center justify-between",children:[l&&e.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:l}),a&&e.jsxs("span",{className:A("text-sm font-semibold font-numerical",i[d]),children:[Math.round(c),"%"]})]}),e.jsx("div",{role:"progressbar","aria-valuenow":Math.round(c),"aria-valuemin":0,"aria-valuemax":100,className:A("w-full bg-muted rounded-full overflow-hidden",{"h-1":n==="sm","h-2":n==="md","h-3":n==="lg"}),children:e.jsx("div",{className:A("h-full rounded-full transition-all duration-300",m?"":i[d]),style:{width:`${c}%`,transitionTimingFunction:"cubic-bezier(0.4, 0.0, 0.2, 1)",...m&&{backgroundColor:m}}})})]})}function Ae(){const[t,s]=o.useState(null),[n,r]=o.useState(!1),[a,l]=o.useState(!1),[m,p]=o.useState(0),[x,c]=o.useState(null),[d,i]=o.useState(0),y=H(b=>b.apiKey),f=o.useRef(null),h=o.useRef(null),j=o.useRef(null),k=o.useRef(null),u=3,C=o.useCallback(()=>{f.current&&(clearTimeout(f.current),f.current=null),h.current&&(clearInterval(h.current),h.current=null),l(!1),p(0),j.current=null},[]),g=o.useCallback(async b=>{if(!y){c("No API key configured");return}if(j.current===b.url&&(n||a))return;C(),j.current=b.url,k.current=b,l(!0),p(1),c(null);let z=1;h.current=setInterval(()=>{z--,p(z),z<=0&&h.current&&(clearInterval(h.current),h.current=null)},1e3),f.current=setTimeout(async()=>{l(!1),r(!0),s(null);try{const N=await je(b.url);if(N){s(N),r(!1),j.current=null;return}const w=he(b);let R="";await K([{role:"system",content:"You are a helpful assistant that analyzes webpages for outreach purposes."},{role:"user",content:w}],y,{onChunk:S=>{R+=S;try{let v=R;const $=v.match(/```(?:json)?\s*([\s\S]*?)```/);$&&(v=$[1]);const L=JSON.parse(v);L.confidence&&s(L)}catch{}},onComplete:async S=>{try{let v=S;const $=v.match(/```(?:json)?\s*([\s\S]*?)```/);$&&(v=$[1]);const L=JSON.parse(v);s(L),await ye(b.url,L),i(0)}catch{c("Failed to parse analysis response")}r(!1),j.current=null},onError:S=>{const v=S instanceof Error?S.message:"Analysis failed";if((v.includes("network")||v.includes("timeout")||v.includes("503")||v.includes("502"))&&d<u){console.log(`[useAnalysis] Retrying (${d+1}/${u})...`),i(Z=>Z+1);const L=Math.pow(2,d)*1e3;setTimeout(()=>{k.current&&g(k.current)},L)}else console.error("[useAnalysis] Analysis error:",{error:S,url:b.url,timestamp:new Date().toISOString(),retries:d}),c(v),r(!1),j.current=null,i(0)}})}catch(N){c(N instanceof Error?N.message:"Analysis failed"),r(!1),j.current=null}},1e3)},[y,n,a,C]);return{analysis:t,isAnalyzing:n,isDebouncing:a,debounceCountdown:m,error:x,analyzePage:g,cancelAnalysis:C}}function Le({initialData:t}){const[s,n]=o.useState(t),[r,a]=o.useState(!t),[l,m]=o.useState("service"),[p,x]=o.useState(!1),[c,d]=o.useState(!1),{analysis:i,isAnalyzing:y,isDebouncing:f,debounceCountdown:h,error:j,analyzePage:k,cancelAnalysis:u}=Ae();o.useEffect(()=>{const N=w=>{if(w.currentPageData){const R=w.currentPageData.newValue;n(R),a(!1),d(!1)}};return chrome.storage.session.onChanged.addListener(N),()=>chrome.storage.session.onChanged.removeListener(N)},[]);const C=()=>{s&&!i&&!y&&!c&&(d(!0),k(s))},g=()=>{setTimeout(()=>x(!0),100)},b=()=>{console.log("Conversation logged")};if(r)return e.jsxs("div",{className:"space-y-4",children:[e.jsx(ke,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-3 bg-muted rounded w-1/4"}),e.jsx("div",{className:"h-3 bg-muted rounded w-full"}),e.jsx("div",{className:"h-3 bg-muted rounded w-5/6"})]})]});if(!s)return e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-[13px] leading-relaxed text-muted-foreground",children:"Waiting for page data..."})});const z=s.isProfile||s.name;return e.jsxs("div",{className:"space-y-4",children:[z?e.jsx(ce,{data:s}):e.jsx(ue,{data:s}),j&&e.jsx(Q,{variant:"error",children:j}),s&&!i&&!y&&!f&&!c&&e.jsx(T,{variant:"default",children:e.jsxs(E,{className:"p-4 text-center",children:[e.jsx("div",{className:"mb-4 flex justify-center",children:e.jsx(O,{variant:"info",size:"md",children:"Ready to analyze"})}),e.jsx("h3",{className:"text-sm font-semibold leading-tight text-foreground mb-2",children:s.name||s.ogTitle||s.hostname}),e.jsxs("p",{className:"text-[13px] leading-relaxed text-muted-foreground mb-6",children:["We'll analyze this ",s.isProfile?"profile":"page"," and generate personalized outreach messages."]}),e.jsx(I,{onClick:C,variant:"primary",size:"md",className:"w-full",children:"Analyze This Page"})]})}),f&&e.jsx(T,{variant:"default",children:e.jsxs(E,{className:"p-4 text-center",children:[e.jsx("div",{className:"flex items-center justify-center gap-2 mb-2",children:e.jsx(O,{variant:"info",size:"sm",children:"Starting analysis..."})}),e.jsxs("p",{className:"text-xs leading-normal text-muted-foreground",children:["Analyzing in ",h," second",h!==1?"s":""]}),e.jsx(I,{onClick:u,variant:"ghost",size:"xs",className:"mt-3",children:"Cancel"})]})}),y&&!i&&e.jsx(T,{variant:"default",children:e.jsx(E,{className:"p-4 text-center",children:e.jsx(O,{variant:"info",size:"sm",children:"Analyzing page..."})})}),i&&e.jsxs(e.Fragment,{children:[e.jsx(T,{variant:"default",children:e.jsxs(E,{className:"p-4",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsx("span",{className:"text-xs leading-normal text-muted-foreground",children:"Confidence"})}),e.jsx(Se,{value:i.confidence,showValue:!0,size:"md"})]}),i.confidenceReason&&e.jsx("p",{className:"text-xs leading-normal text-muted-foreground mt-2",children:i.confidenceReason})]})}),i.summary&&e.jsx(T,{variant:"default",children:e.jsxs(E,{className:"p-4",children:[e.jsx("h3",{className:"text-sm font-semibold leading-tight text-muted-foreground mb-2",children:"Summary"}),e.jsx("p",{className:"text-[13px] leading-relaxed text-muted-foreground",children:i.summary})]})}),i.interests&&i.interests.length>0&&e.jsx(T,{variant:"default",children:e.jsxs(E,{className:"p-4",children:[e.jsx("h3",{className:"text-sm font-semibold leading-tight text-muted-foreground mb-2",children:"Interests"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:i.interests.map((N,w)=>e.jsx(O,{variant:"default",size:"sm",children:N},w))})]})})]}),i&&s&&e.jsx(we,{pageData:s,analysis:i,selectedAngle:l,onSelectAngle:m,onCopy:g}),e.jsx(Ce,{isOpen:p,onClose:()=>x(!1),onLogged:b})]})}export{Le as default};
